<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Edenfield | Callbell Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #020617; color: white; overflow: hidden; font-family: system-ui, -apple-system, sans-serif; }
        .call-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
            padding: 12px;
        }
        .card {
            will-change: transform;
            transition: background-color 0.4s ease, border-color 0.4s ease, transform 0.2s ease-out;
        }
        .card-red { animation: pulse-red 1s infinite; }
        @keyframes pulse-red {
            0%, 100% { background-color: #450a0a; }
            50% { background-color: #991b1b; }
        }
        .timer-font { font-family: 'Courier New', Courier, monospace; font-variant-numeric: tabular-nums; }
        .room-text { font-size: clamp(1.25rem, 3vw, 1.75rem); line-height: 1.2; word-break: break-word; text-transform: uppercase; }

        /* Tabs */
        .tab-btn {
            padding: 6px 16px; font-size: 0.75rem; font-weight: 800;
            text-transform: uppercase; letter-spacing: 0.05em;
            border-radius: 6px; transition: all 0.2s; cursor: pointer;
            border: 1px solid transparent; white-space: nowrap;
        }
        .tab-btn.active { background: rgba(20,184,166,0.2); border-color: #14b8a6; color: #5eead4; }
        .tab-btn:not(.active) { background: rgba(255,255,255,0.05); color: #94a3b8; }
        .tab-btn:not(.active):hover { background: rgba(255,255,255,0.1); color: white; }
        .tab-count {
            display: inline-flex; align-items: center; justify-content: center;
            min-width: 18px; height: 18px; padding: 0 5px;
            border-radius: 9px; font-size: 10px; font-weight: 900; margin-left: 6px;
        }
        .tab-count.has-calls { background: #ef4444; color: white; }
        .tab-count.empty { background: rgba(255,255,255,0.1); color: #64748b; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Settings */
        .settings-panel {
            max-height: 0; overflow: hidden;
            transition: max-height 0.35s ease, padding 0.35s ease, opacity 0.25s ease;
            opacity: 0;
        }
        .settings-panel.open { max-height: 600px; opacity: 1; }
        .threshold-card {
            display: flex; flex-direction: column; align-items: center; gap: 6px;
            padding: 12px 20px; border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.08);
            background: rgba(255,255,255,0.03);
        }
        .threshold-input {
            width: 64px; text-align: center; font-weight: 800; font-size: 1.25rem;
            background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.15);
            border-radius: 8px; color: white; padding: 6px 0;
            outline: none; transition: border-color 0.2s;
        }
        .threshold-input:focus { border-color: rgba(255,255,255,0.4); }
    </style>
</head>
<body class="h-screen flex flex-col">
    <!-- Header -->
    <header class="px-5 py-3 bg-slate-900/90 border-b border-slate-800 flex justify-between items-center shadow-xl backdrop-blur-sm">
        <div class="flex items-center gap-4">
            <h1 class="text-xl font-black uppercase tracking-tighter">
                <span class="text-teal-400">Edenfield</span> Callbell
            </h1>
            <!-- Tabs built dynamically by JS -->
            <div id="tab-bar" class="flex items-center gap-2"></div>
        </div>
        <div class="flex items-center gap-3">
            <!-- Admin controls: hidden for guests, shown only for admin/site_admin -->
            <div id="admin-controls" class="hidden items-center gap-3">
                <button id="settings-toggle" onclick="toggleSettings()"
                    class="px-4 py-1.5 bg-slate-700 hover:bg-slate-600 text-white text-xs font-bold uppercase rounded transition-colors flex items-center gap-1.5">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><circle cx="12" cy="12" r="3"/></svg>
                    Settings
                </button>
                <button onclick="showAppQR()"
                    class="px-4 py-1.5 bg-emerald-600 hover:bg-emerald-500 text-white text-xs font-bold uppercase rounded transition-colors flex items-center gap-1.5">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
                    Edenfield App
                </button>
                <button onclick="resetCalls()"
                    class="px-4 py-1.5 bg-red-600 hover:bg-red-700 text-white text-xs font-bold uppercase rounded transition-colors">Reset All</button>
            </div>
            <!-- Nav buttons: visible to authenticated users -->
            <div id="nav-controls" class="hidden items-center gap-2">
                <a href="/incident-viewer"
                    class="px-4 py-1.5 bg-teal-600 hover:bg-teal-500 text-white text-xs font-bold uppercase rounded transition-colors">Incident Viewer</a>
                <a href="/logout"
                    class="px-4 py-1.5 bg-slate-700 hover:bg-slate-600 text-white text-xs font-bold uppercase rounded transition-colors">Logout</a>
            </div>
            <div id="clock" class="text-2xl font-bold text-slate-400 tabular-nums ml-2" style="font-variant-numeric: tabular-nums;">00:00:00</div>
        </div>
    </header>

    <!-- Settings Panel (admin only) -->
    <div id="settings-panel" class="settings-panel bg-slate-900/95 border-b border-slate-700/50 backdrop-blur-xl">
        <div class="px-5 py-4">
            <div class="flex items-center justify-between mb-3">
                <h2 class="text-sm font-black uppercase tracking-wide text-slate-300">Color Threshold Settings</h2>
                <div class="flex items-center gap-2">
                    <span id="save-status" class="text-xs text-slate-500 hidden">Saved</span>
                    <button onclick="saveSettings()"
                        class="px-5 py-1.5 bg-teal-600 hover:bg-teal-500 text-white text-xs font-bold uppercase rounded transition-colors">
                        Save Changes
                    </button>
                </div>
            </div>
            <div class="flex items-start gap-4">
                <div class="threshold-card">
                    <div class="w-4 h-4 rounded-full" style="background:#22c55e; box-shadow: 0 0 8px #22c55e88;"></div>
                    <span class="text-[10px] font-bold uppercase text-slate-400 tracking-wider">Green Alert</span>
                    <div class="flex items-center gap-1">
                        <input id="set-green" type="number" min="1" max="59" value="3" class="threshold-input" style="color: #86efac;">
                        <span class="text-xs text-slate-500 font-bold">min</span>
                    </div>
                </div>
                <div class="threshold-card">
                    <div class="w-4 h-4 rounded-full" style="background:#d97706; box-shadow: 0 0 8px #d9770688;"></div>
                    <span class="text-[10px] font-bold uppercase text-slate-400 tracking-wider">Yellow Alert</span>
                    <div class="flex items-center gap-1">
                        <input id="set-yellow" type="number" min="1" max="59" value="5" class="threshold-input" style="color: #fcd34d;">
                        <span class="text-xs text-slate-500 font-bold">min</span>
                    </div>
                </div>
                <div class="threshold-card">
                    <div class="w-4 h-4 rounded-full" style="background:#f87171; box-shadow: 0 0 8px #f8717188;"></div>
                    <span class="text-[10px] font-bold uppercase text-slate-400 tracking-wider">Red Alert</span>
                    <div class="flex items-center gap-1">
                        <input id="set-red" type="number" min="1" max="59" value="7" class="threshold-input" style="color: #fca5a5;">
                        <span class="text-xs text-slate-500 font-bold">min</span>
                    </div>
                </div>
                <div class="flex-1 flex items-center">
                    <div class="text-[11px] text-slate-500 leading-relaxed pl-4 border-l border-slate-700/50">
                        <div class="mb-1"><span class="text-yellow-400 font-bold">Assist</span> calls always start from <span class="text-yellow-400 font-bold">Yellow</span></div>
                        <div><span class="text-red-400 font-bold">Emergency</span> calls are always <span class="text-red-400 font-bold">Red</span></div>
                    </div>
                </div>
            </div>

            <!-- Notification Tone -->
            <div class="mt-4 pt-4 border-t border-slate-700/50">
                <h2 class="text-sm font-black uppercase tracking-wide text-slate-300 mb-3">Notification Tone</h2>
                <div class="flex items-center gap-3">
                    <div class="flex items-center gap-2">
                        <label class="tone-option flex items-center gap-2 px-4 py-2 rounded-lg cursor-pointer border border-slate-700/50 hover:border-teal-500/50 transition-all" data-tone="default">
                            <input type="radio" name="notification_tone" value="default" class="accent-teal-500">
                            <span class="text-xs text-slate-300 font-bold">Default</span>
                        </label>
                        <label class="tone-option flex items-center gap-2 px-4 py-2 rounded-lg cursor-pointer border border-slate-700/50 hover:border-teal-500/50 transition-all" data-tone="bell1">
                            <input type="radio" name="notification_tone" value="bell1" class="accent-teal-500">
                            <span class="text-xs text-slate-300 font-bold">Bell 1</span>
                            <button onclick="previewTone('bell1')" class="ml-1 px-2 py-0.5 bg-slate-700 hover:bg-slate-600 text-slate-300 text-[10px] font-bold rounded transition-colors">▶</button>
                        </label>
                        <label class="tone-option flex items-center gap-2 px-4 py-2 rounded-lg cursor-pointer border border-slate-700/50 hover:border-teal-500/50 transition-all" data-tone="bell2">
                            <input type="radio" name="notification_tone" value="bell2" class="accent-teal-500">
                            <span class="text-xs text-slate-300 font-bold">Bell 2</span>
                            <button onclick="previewTone('bell2')" class="ml-1 px-2 py-0.5 bg-slate-700 hover:bg-slate-600 text-slate-300 text-[10px] font-bold rounded transition-colors">▶</button>
                        </label>
                        <label class="tone-option flex items-center gap-2 px-4 py-2 rounded-lg cursor-pointer border border-slate-700/50 hover:border-teal-500/50 transition-all" data-tone="bell3">
                            <input type="radio" name="notification_tone" value="bell3" class="accent-teal-500">
                            <span class="text-xs text-slate-300 font-bold">Bell 3</span>
                            <button onclick="previewTone('bell3')" class="ml-1 px-2 py-0.5 bg-slate-700 hover:bg-slate-600 text-slate-300 text-[10px] font-bold rounded transition-colors">▶</button>
                        </label>
                    </div>
                    <button id="stop-preview" onclick="stopPreview()" class="hidden px-3 py-1.5 bg-red-600 hover:bg-red-500 text-white text-[10px] font-bold uppercase rounded transition-colors">■ Stop</button>
                </div>
            </div>

            <!-- App Config -->
            <div class="mt-4 pt-4 border-t border-slate-700/50">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-sm font-black uppercase tracking-wide text-slate-300">Mobile App Config</h2>
                    <div class="flex items-center gap-2">
                        <span id="app-save-status" class="text-xs text-slate-500 hidden">Saved</span>
                        <button onclick="saveAppConfig()"
                            class="px-5 py-1.5 bg-teal-600 hover:bg-teal-500 text-white text-xs font-bold uppercase rounded transition-colors">
                            Save App Config
                        </button>
                    </div>
                </div>
                <div class="flex items-start gap-6">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input id="cfg-require-staff-name" type="checkbox" checked class="w-4 h-4 accent-teal-500">
                        <span class="text-xs text-slate-300 font-bold">Require Staff Name</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input id="cfg-show-timer" type="checkbox" class="w-4 h-4 accent-teal-500">
                        <span class="text-xs text-slate-300 font-bold">Show Timer (App)</span>
                    </label>
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-slate-400 font-bold">Poll Interval</span>
                        <input id="cfg-poll-interval" type="number" min="1000" max="30000" step="500" value="1000"
                            class="threshold-input" style="width:80px; font-size:0.85rem; color:#5eead4;">
                        <span class="text-xs text-slate-500 font-bold">ms</span>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- QR Code Modal -->
    <div id="qr-modal" class="fixed inset-0 z-50 hidden items-center justify-center" style="background:rgba(0,0,0,0.7); backdrop-filter:blur(4px);">
        <div class="bg-slate-800 rounded-2xl p-6 shadow-2xl border border-slate-600/50 max-w-sm w-full mx-4 text-center relative">
            <button onclick="hideAppQR()" class="absolute top-3 right-3 text-slate-400 hover:text-white text-xl font-bold">&times;</button>
            <div class="mb-4">
                <div class="w-12 h-12 rounded-full bg-emerald-600/20 flex items-center justify-center mx-auto mb-3">
                    <svg class="w-6 h-6 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
                </div>
                <h3 class="text-lg font-bold text-white">Edenfield Callbell App</h3>
                <p class="text-xs text-slate-400 mt-1">Scan with your phone to download the latest version</p>
            </div>
            <div class="bg-white rounded-xl p-3 inline-block mb-4">
                <img id="qr-image" src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=https://expo.dev/accounts/maxvo/projects/edenfield-callbell" alt="QR Code" width="200" height="200">
            </div>
            <div class="text-[11px] text-slate-500">
                <p>1. Scan QR code with your phone camera</p>
                <p>2. Tap the latest build to download</p>
                <p>3. App auto-updates after first install</p>
            </div>
        </div>
    </div>

    <!-- Main Content: call grids + staff sidebar -->
    <div class="flex-1 flex overflow-hidden">
        <main id="main-content" class="flex-1 overflow-y-auto relative">
            <!-- CLEAR overlay (shared) -->
            <div id="no-calls" class="fixed inset-0 flex items-center justify-center opacity-5 pointer-events-none hidden" style="z-index:0;">
                <h2 class="text-9xl font-black italic">CLEAR</h2>
            </div>
        </main>

        <!-- Right sidebar: Staff Online (admin only) -->
        <aside id="staff-sidebar" class="hidden w-80 bg-slate-900/95 border-l border-slate-700/50 overflow-y-auto flex-shrink-0">
            <div class="px-5 py-4">
                <h2 class="text-sm font-black uppercase tracking-wider text-slate-400 mb-4 flex items-center gap-2">
                    <div class="w-2.5 h-2.5 rounded-full bg-green-400 animate-pulse"></div>
                    Staff Online
                </h2>
                <div id="staff-online-list" class="text-sm text-slate-400"></div>
            </div>
        </aside>
    </div>

    <script>
        // ── State ──
        let sites = [];          // [{id, name}] from server
        let activeTab = null;
        let timerEnabled = false;
        let isAdmin = false;
        let authChecked = false;
        const siteState = {};    // siteId -> { prevJson, callCount }
        let prevPollJson = '';   // full response dedup

        // ── QR Modal ──
        const showAppQR = async () => {
            const modal = document.getElementById('qr-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            try {
                const res = await fetch('/api/app/download-url');
                const data = await res.json();
                if (data.success && data.url) {
                    document.getElementById('qr-image').src =
                        'https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=' + encodeURIComponent(data.url);
                }
            } catch(e) { console.warn('Failed to fetch download URL', e); }
        };
        const hideAppQR = () => {
            const modal = document.getElementById('qr-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        };
        // Close on backdrop click
        document.getElementById('qr-modal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) hideAppQR();
        });

        // ── Build Tabs + Grids dynamically ──
        function buildUI(siteList) {
            if (siteList.length === 0) return;

            // Only rebuild if site list changed
            const ids = siteList.map(s => s.id).join(',');
            if (sites.map(s => s.id).join(',') === ids) return;

            sites = siteList;
            if (!activeTab || !siteState[activeTab]) activeTab = sites[0].id;

            // Build tab bar
            const tabBar = document.getElementById('tab-bar');
            tabBar.innerHTML = '';
            if (sites.length > 1) {
                sites.forEach(s => {
                    const btn = document.createElement('button');
                    btn.className = 'tab-btn' + (s.id === activeTab ? ' active' : '');
                    btn.dataset.site = s.id;
                    btn.onclick = function() { switchTab(s.id); };
                    btn.innerHTML = s.name + ' <span class="tab-count empty" id="count-' + s.id + '">0</span>';
                    tabBar.appendChild(btn);
                });
            } else if (sites.length === 1) {
                const label = document.createElement('span');
                label.className = 'text-sm font-bold text-slate-400 uppercase tracking-wide';
                label.textContent = sites[0].name;
                tabBar.appendChild(label);
            }

            // Build grid containers
            const main = document.getElementById('main-content');
            // Remove old tab-content divs but keep #no-calls
            Array.from(main.children).forEach(el => {
                if (el.id !== 'no-calls') el.remove();
            });
            sites.forEach((s, i) => {
                if (!siteState[s.id]) siteState[s.id] = { prevJson: '', callCount: 0 };
                const div = document.createElement('div');
                div.id = 'tab-' + s.id;
                div.className = 'tab-content' + (s.id === activeTab ? ' active' : '');
                div.innerHTML = '<div id="call-grid-' + s.id + '" class="call-grid"></div>';
                main.insertBefore(div, document.getElementById('no-calls'));
            });
        }

        // ── Tab Switching ──
        function switchTab(siteId) {
            activeTab = siteId;
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.site === siteId);
            });
            document.querySelectorAll('.tab-content').forEach(el => {
                el.classList.toggle('active', el.id === 'tab-' + siteId);
            });
            updateClearMessage();
            if (isAdmin) {
                document.getElementById('staff-online-list').innerHTML = '<div class="text-slate-600 text-[11px] italic py-2">Loading...</div>';
                pollStaffOnline();
            }
        }

        function updateClearMessage() {
            const empty = document.getElementById('no-calls');
            if (!activeTab || !siteState[activeTab]) { empty.classList.add('hidden'); return; }
            if (siteState[activeTab].callCount === 0) {
                empty.classList.remove('hidden');
            } else {
                empty.classList.add('hidden');
            }
        }

        // ── Settings Panel ──
        const toggleSettings = () => {
            document.getElementById('settings-panel').classList.toggle('open');
        };

        let previewAudio = null;

        const previewTone = (tone) => {
            stopPreview();
            previewAudio = new Audio('/static/sounds/' + tone + '.mp3');
            previewAudio.play();
            document.getElementById('stop-preview').classList.remove('hidden');
            previewAudio.onended = () => { document.getElementById('stop-preview').classList.add('hidden'); };
        };

        const stopPreview = () => {
            if (previewAudio) { previewAudio.pause(); previewAudio.currentTime = 0; previewAudio = null; }
            document.getElementById('stop-preview').classList.add('hidden');
        };

        const applySettings = (settings) => {
            if (!settings) return;
            document.getElementById('set-green').value = settings.green_minutes || 3;
            document.getElementById('set-yellow').value = settings.yellow_minutes || 5;
            document.getElementById('set-red').value = settings.red_minutes || 7;
            // Apply notification tone
            const tone = settings.notification_tone || 'bell1';
            const radio = document.querySelector('input[name="notification_tone"][value="' + tone + '"]');
            if (radio) radio.checked = true;
            // Highlight selected tone
            document.querySelectorAll('.tone-option').forEach(el => {
                el.classList.toggle('border-teal-500', el.dataset.tone === tone);
            });
        };

        // Update tone highlight on change
        document.querySelectorAll('input[name="notification_tone"]').forEach(radio => {
            radio.addEventListener('change', () => {
                document.querySelectorAll('.tone-option').forEach(el => {
                    el.classList.toggle('border-teal-500', el.dataset.tone === radio.value && radio.checked);
                    el.classList.toggle('border-slate-700/50', !(el.dataset.tone === radio.value && radio.checked));
                });
            });
        });

        const saveSettings = async () => {
            const green = parseInt(document.getElementById('set-green').value);
            const yellow = parseInt(document.getElementById('set-yellow').value);
            const red = parseInt(document.getElementById('set-red').value);

            if (!(green < yellow && yellow < red && green > 0)) {
                alert('Thresholds must be: Green < Yellow < Red (all > 0)');
                return;
            }

            try {
                const res = await fetch('/api/callbell/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ green_minutes: green, yellow_minutes: yellow, red_minutes: red, notification_tone: document.querySelector('input[name="notification_tone"]:checked')?.value || 'bell1' })
                });
                const data = await res.json();
                if (data.status === 'ok') {
                    const status = document.getElementById('save-status');
                    status.classList.remove('hidden');
                    status.textContent = 'Saved!';
                    status.className = 'text-xs text-green-400 font-bold';
                    setTimeout(() => { status.classList.add('hidden'); }, 2000);
                    prevPollJson = '';  // force re-render on next poll
                } else {
                    alert(data.message || 'Failed to save');
                }
            } catch (e) { alert('Error saving settings'); }
        };

        // ── Timer Toggle ──
        const toggleTimer = (enabled) => {
            timerEnabled = enabled;
            if (isAdmin) localStorage.setItem('callbell_timer_enabled', enabled);
            const onBtn = document.getElementById('timer-on-btn');
            const offBtn = document.getElementById('timer-off-btn');
            if (onBtn && offBtn) {
                if (enabled) {
                    onBtn.className = 'px-4 py-1.5 bg-green-600 hover:bg-green-700 text-white text-xs font-bold uppercase rounded transition-colors';
                    offBtn.className = 'px-4 py-1.5 bg-slate-600 hover:bg-slate-700 text-white text-xs font-bold uppercase rounded transition-colors';
                } else {
                    onBtn.className = 'px-4 py-1.5 bg-slate-600 hover:bg-slate-700 text-white text-xs font-bold uppercase rounded transition-colors';
                    offBtn.className = 'px-4 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold uppercase rounded transition-colors';
                }
            }
            const timers = document.getElementsByClassName('timer-font');
            for (let i = 0; i < timers.length; i++) {
                timers[i].style.display = enabled ? 'block' : 'none';
            }
        };
        toggleTimer(false);

        // ── Clock ──
        setInterval(() => {
            document.getElementById('clock').textContent = new Date().toLocaleTimeString('en-GB');
        }, 1000);

        // ── Dark-theme card colors for web UI ──
        const WEB_CARD_STYLES = {
            gray:   { bg: '#1e293b', border: '#475569', text: '#94a3b8' },
            green:  { bg: '#052e16', border: '#22c55e', text: '#86efac' },
            yellow: { bg: '#422006', border: '#d97706', text: '#fcd34d' },
            red:    { bg: '#450a0a', border: '#ef4444', text: '#fca5a5' },
        };

        // ── Render Card ──
        const syncUI = (siteId, data) => {
            const grid = document.getElementById('call-grid-' + siteId);
            if (!grid) return;
            const cardId = 'room-' + siteId + '-' + data.room;
            let card = document.getElementById(cardId);
            if (!card) {
                card = document.createElement('div');
                card.id = cardId;
                grid.appendChild(card);
            }

            const level = data.card_level || 'gray';
            const isRed = level === 'red';
            const webStyle = WEB_CARD_STYLES[level] || WEB_CARD_STYLES.gray;

            card.className = 'card p-4 rounded-xl shadow-lg flex flex-col justify-between ' + (isRed ? 'card-red' : '');
            card.style.backgroundColor = isRed ? '' : webStyle.bg;
            card.style.borderWidth = '2px';
            card.style.borderStyle = 'solid';
            card.style.borderColor = webStyle.border;
            card.dataset.priority = data.priority;
            card.dataset.start = data.start;
            card.dataset.level = level;

            const label = data.messageText || data.room;
            const cancelBtn = isAdmin
                ? '<button onclick="cancelCall(\'' + siteId + '\', \'' + data.room.replace(/'/g, "\\'") + '\', \'' + (data.event_id || '').replace(/'/g, "\\'") + '\')" ' +
                  'class="mt-2 px-3 py-1 bg-red-700/60 hover:bg-red-600 text-red-200 text-[11px] font-bold uppercase rounded transition-colors">✕ Cancelled</button>'
                : '';

            card.innerHTML =
                '<div class="room-text font-black" style="color:' + webStyle.text + '">' + label + '</div>' +
                '<div class="flex justify-between items-end mt-3">' +
                    '<div>' + cancelBtn + '</div>' +
                    '<div class="text-4xl font-bold timer-font tabular-nums" data-start="' + data.start + '" style="display: ' + (timerEnabled ? 'block' : 'none') + '; color: ' + webStyle.text + '">00:00</div>' +
                '</div>';
        };

        const updateCount = (siteId, count) => {
            siteState[siteId].callCount = count;
            updateClearMessage();
        };

        // ── Single Poll: ONE request for everything ──
        const poll = async () => {
            try {
                const res = await fetch('/api/callbell/poll');
                const data = await res.json();

                // Build / rebuild tabs if site list changed
                buildUI(data.sites || []);

                // Handle auth (from same response, no extra request)
                if (!authChecked) {
                    authChecked = true;
                    // Show nav buttons (Incident Viewer + Logout) for any logged-in user
                    if (data.role) {
                        document.getElementById('nav-controls').classList.remove('hidden');
                        document.getElementById('nav-controls').classList.add('flex');
                    }
                    if (data.is_admin) {
                        isAdmin = true;
                        document.getElementById('admin-controls').classList.remove('hidden');
                        document.getElementById('admin-controls').classList.add('flex');
                        document.getElementById('staff-sidebar').classList.remove('hidden');
                        applySettings(data.settings);
                        const saved = localStorage.getItem('callbell_timer_enabled');
                        timerEnabled = saved !== null ? saved === 'true' : true;
                        toggleTimer(timerEnabled);
                    } else {
                        timerEnabled = false;
                        toggleTimer(false);
                    }
                }

                // Check if data actually changed (dedup across ALL sites)
                const callsJson = JSON.stringify(data.calls_by_site || {});
                if (callsJson === prevPollJson) return;
                prevPollJson = callsJson;

                // Update each site's grid
                const callsBySite = data.calls_by_site || {};
                sites.forEach(s => {
                    const calls = callsBySite[s.id] || [];

                    // Update tab badge
                    const countEl = document.getElementById('count-' + s.id);
                    if (countEl) {
                        countEl.textContent = calls.length;
                        countEl.className = 'tab-count ' + (calls.length > 0 ? 'has-calls' : 'empty');
                    }

                    // Rebuild grid in API order (API sorts: critical first, longest timer first)
                    const grid = document.getElementById('call-grid-' + s.id);
                    if (!grid) return;
                    grid.innerHTML = '';
                    calls.forEach(c => syncUI(s.id, c));
                    updateCount(s.id, calls.length);
                });

            } catch (e) { console.warn('Poll failed:', e); }
        };

        poll();
        setInterval(poll, 1000);

        // ── Cancel a single call ──
        const cancelCall = async (siteId, room, eventId) => {
            if (!confirm('Cancel call: ' + room + '?')) return;
            try {
                await fetch('/api/callbell/' + siteId + '/cancel-call', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ room: room, event_id: eventId })
                });
                prevPollJson = ''; // force re-render
            } catch (e) { console.warn('Cancel call failed:', e); }
        };

        // ── Reset (active tab only) — clears calls AND staff sessions ──
        const resetCalls = async () => {
            if (!activeTab) return;
            const site = sites.find(s => s.id === activeTab);
            const siteName = site ? site.name : activeTab;
            if (!confirm('Clear all active calls AND log out all staff for ' + siteName + '?')) return;
            await fetch('/api/callbell/' + activeTab + '/reset', { method: 'POST' });
            const grid = document.getElementById('call-grid-' + activeTab);
            if (grid) grid.innerHTML = '';
            siteState[activeTab].prevJson = '';
            siteState[activeTab].callCount = 0;
            prevPollJson = '';
            updateClearMessage();
            if (isAdmin) pollStaffOnline();
        };

        // ── Timer Animation ──
        const runTimers = () => {
            const now = Math.floor(Date.now() / 1000);
            const timers = document.getElementsByClassName('timer-font');
            for (let i = 0; i < timers.length; i++) {
                const start = Math.floor(parseFloat(timers[i].dataset.start));
                const diff = now - start;
                const m = (diff / 60 | 0).toString().padStart(2, '0');
                const s = (diff % 60).toString().padStart(2, '0');
                const t = m + ':' + s;
                if (timers[i].textContent !== t) timers[i].textContent = t;
            }
            requestAnimationFrame(runTimers);
        };
        requestAnimationFrame(runTimers);

        updateClearMessage();

        // ── App Config (admin only) ──
        const loadAppConfig = async () => {
            try {
                const res = await fetch('/api/app/admin/config');
                const data = await res.json();
                if (data.success && data.config) {
                    const c = data.config;
                    document.getElementById('cfg-require-staff-name').checked = !!c.require_staff_name;
                    document.getElementById('cfg-show-timer').checked = !!c.show_timer;
                    document.getElementById('cfg-poll-interval').value = c.poll_interval_ms || 3000;
                }
            } catch (e) { console.warn('Failed to load app config:', e); }
        };

        const saveAppConfig = async () => {
            const cfg = {
                require_staff_name: document.getElementById('cfg-require-staff-name').checked,
                show_timer: document.getElementById('cfg-show-timer').checked,
                poll_interval_ms: parseInt(document.getElementById('cfg-poll-interval').value) || 3000,
            };
            try {
                const res = await fetch('/api/app/admin/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(cfg)
                });
                const data = await res.json();
                if (data.success) {
                    const status = document.getElementById('app-save-status');
                    status.classList.remove('hidden');
                    status.textContent = 'Saved!';
                    status.className = 'text-xs text-green-400 font-bold';
                    setTimeout(() => { status.classList.add('hidden'); }, 2000);
                } else {
                    alert(data.message || 'Failed to save');
                }
            } catch (e) { alert('Error saving app config'); }
        };

        // ── Staff Online (admin only, right sidebar) ──
        // For admin: filters by active tab site. For site_admin: shows their site only.
        const pollStaffOnline = async () => {
            try {
                // Find the display name of the active tab's site
                const activeSite = sites.find(s => s.id === activeTab);
                const siteName = activeSite ? activeSite.name : '';
                const url = siteName
                    ? '/api/app/admin/staff-online?site=' + encodeURIComponent(siteName)
                    : '/api/app/admin/staff-online';
                const res = await fetch(url);
                const data = await res.json();
                const el = document.getElementById('staff-online-list');
                if (!data.success || !data.staff || data.staff.length === 0) {
                    el.innerHTML = '<div class="text-slate-600 text-[11px] italic py-2">No staff online</div>';
                    return;
                }
                el.innerHTML = data.staff.map(s => {
                    const totalMin = s.online_minutes || 0;
                    const h = Math.floor(totalMin / 60);
                    const m = Math.floor(totalMin % 60);
                    const sec = Math.round((totalMin % 1) * 60);
                    const timeStr = h > 0
                        ? h + 'h ' + m.toString().padStart(2,'0') + 'm ' + sec.toString().padStart(2,'0') + 's'
                        : m + 'm ' + sec.toString().padStart(2,'0') + 's';
                    const areasHtml = s.areas && s.areas.length > 0
                        ? '<div class="flex flex-wrap gap-1 mt-1">' + s.areas.map(a => '<span class="px-2 py-0.5 bg-teal-900/50 text-teal-300 text-xs font-bold rounded">' + a + '</span>').join('') + '</div>'
                        : '';
                    return '<div class="py-3 border-b border-slate-800/50">' +
                        '<div class="flex items-center gap-2">' +
                        '<div class="w-2.5 h-2.5 rounded-full bg-green-400 flex-shrink-0"></div>' +
                        '<div class="min-w-0 flex-1">' +
                        '<div class="text-slate-200 font-bold text-sm truncate">' + (s.staff_name || s.username) + '</div>' +
                        '<div class="text-slate-500 text-xs mt-0.5">' + timeStr + '</div>' +
                        areasHtml +
                        '</div></div></div>';
                }).join('');
            } catch (e) { /* ignore - not admin */ }
        };

        // Load admin data after auth check
        setTimeout(() => {
            if (isAdmin) {
                loadAppConfig();
                pollStaffOnline();
                setInterval(pollStaffOnline, 10000);
            }
        }, 2000);
    </script>
</body>
</html>
