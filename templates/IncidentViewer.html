<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Incident Viewer - Progress Report System</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --light-bg: #ecf0f1;
            --dark-text: #2c3e50;
            --border-color: #bdc3c7;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--dark-text);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-info h1 {
            font-size: 2.5em;
            color: var(--primary-color);
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header-info p {
            font-size: 1.2em;
            color: #7f8c8d;
            margin-bottom: 5px;
        }

        .user-info {
            text-align: right;
        }

        .user-name {
            font-size: 1.3em;
            font-weight: 600;
            color: var(--secondary-color);
        }

        .user-role {
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .site-selector {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .site-label {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 1.1em;
        }

        .site-select {
            padding: 12px 20px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 1em;
            background: white;
            color: var(--dark-text);
            min-width: 200px;
        }

        .date-selector {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .date-input {
            padding: 10px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1em;
        }

        .btn-load {
            background: var(--secondary-color);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .btn-load:hover {
            background: #2980b9;
        }

        .btn-back {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .btn-back:hover {
            background: #c0392b;
        }

        .btn-logout {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(231, 76, 60, 0.3);
        }

        .btn-logout:hover {
            background: linear-gradient(135deg, #c0392b, #a93226);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4);
        }

        .incident-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .incident-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .incident-card.high-risk {
            background: #ffccbc;
            border: 3px solid #e65100;
            box-shadow: 0 0 10px rgba(230, 81, 0, 0.3);
        }

        .incident-card {
            cursor: pointer;
        }
        
        .incident-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }

        /* Alarm sending button styles */
        .alarm-button {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }

        .alarm-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
            background: linear-gradient(135deg, #ff5252, #d63031);
        }

        .alarm-button:active {
            transform: translateY(0);
        }

        .alarm-button.sending {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            cursor: not-allowed;
        }

        .alarm-button.success {
            background: linear-gradient(135deg, #00b894, #00a085);
            cursor: not-allowed;
        }

        .alarm-button.error {
            background: linear-gradient(135deg, #e17055, #d63031);
            cursor: not-allowed;
        }

        .alarm-button.high-priority {
            background: linear-gradient(135deg, #ff4757, #c44569);
            animation: pulse 2s infinite;
            box-shadow: 0 0 20px rgba(255, 71, 87, 0.5);
        }

        .alarm-button.high-priority:hover {
            background: linear-gradient(135deg, #ff3742, #b33939);
            transform: translateY(-2px);
            box-shadow: 0 0 30px rgba(255, 71, 87, 0.7);
        }

        .workflow-button {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px;
            width: 100%;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .workflow-button:hover {
            background: linear-gradient(135deg, #2980b9, #1f618d);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        .workflow-button:active {
            transform: translateY(0);
        }

        .workflow-button.creating {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            cursor: not-allowed;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 20px rgba(226, 5, 23, 0.5);
            }
            50% {
                box-shadow: 0 0 30px rgba(226, 5, 23, 0.8);
            }
            100% {
                box-shadow: 0 0 20px rgba(226, 5, 23, 0.5);
            }
        }

        /* Alarm status display */
        .alarm-status {
            margin-top: 10px;
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            text-align: center;
            font-weight: 500;
        }

        .alarm-status.sending {
            background: #e3f2fd;
            color: #1976d2;
        }

        .alarm-status.success {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .alarm-status.error {
            background: #ffebee;
            color: #c62828;
        }

        /* Alarm sending modal styles */
        .alarm-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .alarm-modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .alarm-modal-title {
            font-size: 1.5em;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        .alarm-modal-message {
            color: var(--dark-text);
            line-height: 1.6;
            margin-bottom: 25px;
        }

        .alarm-modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .alarm-modal-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .alarm-modal-btn.confirm {
            background: var(--success-color);
            color: white;
        }

        .alarm-modal-btn.confirm:hover {
            background: #229954;
        }

        .alarm-modal-btn.cancel {
            background: var(--light-bg);
            color: var(--dark-text);
        }

        .alarm-modal-btn.cancel:hover {
            background: #d5dbdb;
        }

        /* Advanced alarm management styles */
        .alarm-section {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .priority-urgent {
            color: var(--accent-color);
        }

        .priority-high {
            color: var(--warning-color);
        }

        .priority-normal {
            color: var(--secondary-color);
        }

        .priority-low {
            color: var(--success-color);
        }

        /* Modal internal form styles */
        .alarm-modal-content form input,
        .alarm-modal-content form select,
        .alarm-modal-content form textarea {
            font-family: inherit;
            font-size: 14px;
        }

        .alarm-modal-content form label {
            color: var(--dark-text);
            font-weight: 600;
        }
        
        /* Popup Styles */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .popup-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-bg);
        }
        
        .popup-title {
            font-size: 1.5em;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .popup-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #7f8c8d;
            padding: 5px;
            border-radius: 50%;
            transition: background-color 0.3s ease;
        }
        
        .popup-close:hover {
            background: var(--light-bg);
        }
        
        .popup-details {
            display: grid;
            gap: 15px;
        }
        
        .popup-detail-row {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .popup-detail-label {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 1.1em;
        }
        
        .popup-detail-value {
            color: var(--dark-text);
            line-height: 1.6;
            background: var(--light-bg);
            padding: 15px;
            border-radius: 8px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .incident-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-bg);
        }

        .incident-title {
            font-size: 1.4em;
            font-weight: 600;
            color: var(--primary-color);
        }

        .incident-date {
            font-size: 0.9em;
            color: #7f8c8d;
            background: var(--light-bg);
            padding: 5px 10px;
            border-radius: 15px;
        }

        .incident-details {
            display: grid;
            gap: 15px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 8px 0;
            border-bottom: 1px solid var(--light-bg);
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: 600;
            color: var(--primary-color);
            min-width: 120px;
        }

        .detail-value {
            color: var(--dark-text);
            text-align: left;
            max-width: 300px;
            word-wrap: break-word;
            line-height: 1.4;
        }

        .risk-high {
            color: #e74c3c;
            font-weight: 600;
        }

        .risk-medium {
            color: #f39c12;
            font-weight: 600;
        }

        .risk-low {
            color: #27ae60;
            font-weight: 600;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: var(--secondary-color);
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
        }

        .no-data {
            text-align: center;
            padding: 50px;
            color: #7f8c8d;
            font-size: 1.1em;
        }

        .stats-summary {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 20px;
            background: var(--light-bg);
            border-radius: 10px;
        }

        .stat-number {
            font-size: 2em;
            font-weight: 700;
            color: var(--secondary-color);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-info">
                <h1>üö® Incident Viewer</h1>
                <p>Progress Report System - Incident Management</p>
                <p>Selected Site: <strong>{{ site }}</strong></p>
            </div>
            <div class="user-info">
                <div class="user-name">{{ current_user.display_name }}</div>
                <div class="user-role">{{ current_user.role }} - {{ current_user.position }}</div>
                {% if current_user.role in ['admin', 'site_admin'] %}
                <button class="btn-back" onclick="window.location.href='/policy-management'" style="margin-right: 10px;">‚öôÔ∏è Policy Management</button>
                <button class="btn-back" onclick="window.location.href='/fcm-admin-dashboard'" style="margin-right: 10px;">üî• FCM Dashboard</button>
                <button class="btn-back" onclick="window.location.href='/admin-settings'" style="margin-right: 10px; background-color: #6c757d; color: white;">üîß Settings</button>
                {% endif %}
                <button class="btn-back" onclick="window.location.href='/progress-notes'" style="margin-right: 10px;">‚Üê Back to Progress Notes</button>
                <button class="btn-logout" onclick="window.location.href='/logout'">Logout</button>
            </div>
        </div>

        <!-- Site and Date Selector -->
        <div class="site-selector">
            <div>
                <span class="site-label">Select Site:</span>
                <select id="siteSelect" class="site-select" onchange="changeSite(this.value)">
                    {% for site_info in sites %}
                    <option value="{{ site_info.name }}" {% if site_info.is_selected %}selected{% endif %}>
                        {{ site_info.name }} ({{ site_info.server }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="date-selector">
                <label for="startDate">From:</label>
                <input type="date" id="startDate" class="date-input">
                <label for="endDate">To:</label>
                <input type="date" id="endDate" class="date-input">
                <button class="btn-load" onclick="loadIncidents()">üîç Load Incidents</button>
            </div>
        </div>

        <!-- Stats Summary -->
        <div class="stats-summary" id="statsSummary" style="display: none;">
            <h3 style="margin-bottom: 20px; color: var(--primary-color);">üìä Incident Summary</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-number" id="totalIncidents">-</div>
                    <div class="stat-label">Total Incidents</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="highRiskIncidents">-</div>
                    <div class="stat-label">High Risk</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="mediumRiskIncidents">-</div>
                    <div class="stat-label">Medium Risk</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="lowRiskIncidents">-</div>
                    <div class="stat-label">Low Risk</div>
                </div>
            </div>
        </div>

        <!-- Alarm Sending History -->
        <div class="stats-summary" id="alarmHistory" style="display: none;">
            <h3 style="margin-bottom: 20px; color: var(--primary-color);">üì± Recent Alarm History</h3>
            <div id="alarmHistoryContent">
                <!-- Alarm history will be displayed here -->
            </div>
        </div>

        <!-- Advanced Alarm Management Panel -->
        <div class="stats-summary" id="advancedAlarmPanel" style="display: none;">
            <h3 style="margin-bottom: 20px; color: var(--primary-color);">‚öôÔ∏è Advanced Alarm Management</h3>
            
            <!-- Alarm Template Management -->
            <div class="alarm-section">
                <h4 style="color: var(--secondary-color); margin-bottom: 15px;">üìã Alarm Templates</h4>
                <div id="alarmTemplatesContent">
                    <!-- Template list will be displayed here -->
                </div>
                <button class="alarm-modal-btn confirm" onclick="showCreateTemplateModal()" style="margin-top: 15px;">
                    ‚ûï Create New Template
                </button>
            </div>

            <!-- Recipient Management -->
            <div class="alarm-section" style="margin-top: 30px;">
                <h4 style="color: var(--secondary-color); margin-bottom: 15px;">üë• Recipients</h4>
                <div id="alarmRecipientsContent">
                    <!-- Recipient list will be displayed here -->
                </div>
                <button class="alarm-modal-btn confirm" onclick="showAddRecipientModal()" style="margin-top: 15px;">
                    ‚ûï Add New Recipient
                </button>
            </div>

            <!-- Escalation Status -->
            <div class="alarm-section" style="margin-top: 30px;">
                <h4 style="color: var(--secondary-color); margin-bottom: 15px;">üö® Escalation Status</h4>
                <div id="escalationStatusContent">
                    <!-- Escalation status will be displayed here -->
                </div>
            </div>
        </div>

        <!-- Advanced Alarm Management Toggle Button -->
        <div style="text-align: center; margin-top: 20px;">
            <button class="alarm-modal-btn confirm" onclick="toggleAdvancedAlarmPanel()" id="toggleAdvancedPanelBtn">
                ‚öôÔ∏è Show Advanced Alarm Management
            </button>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="loading" style="display: none;">
            <div>üîÑ Loading incidents...</div>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="error" style="display: none;">
            <div id="errorText"></div>
        </div>

        <!-- No Data Message -->
        <div id="noDataMessage" class="no-data" style="display: none;">
            <div>üì≠ No incidents found for the selected period</div>
        </div>

        <!-- Incidents Grid -->
        <div class="incident-grid" id="incidentGrid">
            <!-- Incidents will be populated here -->
        </div>
        
        <!-- Incident Detail Popup -->
        <div id="incidentPopup" class="popup-overlay">
            <div class="popup-content">
                <div class="popup-header">
                    <div class="popup-title" id="popupTitle">Incident Details</div>
                    <button class="popup-close" onclick="closeIncidentPopup()">&times;</button>
                </div>
                <div class="popup-details" id="popupDetails">
                    <!-- Popup content will be populated here -->
                </div>
            </div>
        </div>

        <!-- Alarm Sending Confirmation Modal -->
        <div id="alarmModal" class="alarm-modal">
            <div class="alarm-modal-content">
                <div class="alarm-modal-title">üö® Send Alarm to Mobile</div>
                <div class="alarm-modal-message" id="alarmModalMessage">
                    Are you sure you want to send an alarm to mobile devices for this incident?
                </div>
                <div class="alarm-modal-buttons">
                    <button class="alarm-modal-btn confirm" id="alarmModalConfirm">Send Alarm</button>
                    <button class="alarm-modal-btn cancel" onclick="closeAlarmModal()">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Template Creation Modal -->
        <div id="templateModal" class="alarm-modal">
            <div class="alarm-modal-content" style="max-width: 600px;">
                <div class="alarm-modal-title">üìã Create Alarm Template</div>
                <div class="alarm-modal-message">
                    <form id="templateForm" style="text-align: left;">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Template Name:</label>
                            <input type="text" id="templateName" required style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 5px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Title:</label>
                            <input type="text" id="templateTitle" required style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 5px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Body:</label>
                            <textarea id="templateBody" required rows="3" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 5px;"></textarea>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Priority:</label>
                            <select id="templatePriority" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 5px;">
                                <option value="low">Low</option>
                                <option value="normal" selected>Normal</option>
                                <option value="high">High</option>
                                <option value="urgent">Urgent</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Category:</label>
                            <select id="templateCategory" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 5px;">
                                <option value="incident" selected>Incident</option>
                                <option value="maintenance">Maintenance</option>
                                <option value="emergency">Emergency</option>
                                <option value="general">General</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">
                                <input type="checkbox" id="templateEscalation"> Enable Escalation
                            </label>
                        </div>
                        <div style="margin-bottom: 15px;" id="escalationDelayDiv" style="display: none;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Escalation Delay (minutes):</label>
                            <input type="number" id="templateEscalationDelay" min="1" value="5" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 5px;">
                        </div>
                    </form>
                </div>
                <div class="alarm-modal-buttons">
                    <button class="alarm-modal-btn confirm" onclick="createTemplate()">Create Template</button>
                    <button class="alarm-modal-btn cancel" onclick="closeTemplateModal()">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Add Recipient Modal -->
        <div id="recipientModal" class="alarm-modal">
            <div class="alarm-modal-content" style="max-width: 600px;">
                <div class="alarm-modal-title">üë• Add New Recipient</div>
                <div class="alarm-modal-message">
                    <form id="recipientForm" style="text-align: left;">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">User ID:</label>
                            <input type="text" id="recipientUserId" required style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 5px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Name:</label>
                            <input type="text" id="recipientName" required style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 5px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Email:</label>
                            <input type="email" id="recipientEmail" required style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 5px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Phone:</label>
                            <input type="tel" id="recipientPhone" required style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 5px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Role:</label>
                            <select id="recipientRole" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 5px;">
                                <option value="supervisor">Supervisor</option>
                                <option value="manager">Manager</option>
                                <option value="emergency">Emergency</option>
                                <option value="maintenance">Maintenance</option>
                                <option value="general">General</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Team:</label>
                            <input type="text" id="recipientTeam" required style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 5px;">
                        </div>
                    </form>
                </div>
                <div class="alarm-modal-buttons">
                    <button class="alarm-modal-btn confirm" onclick="addRecipient()">Add Recipient</button>
                    <button class="alarm-modal-btn cancel" onclick="closeRecipientModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentSite = '{{ site }}';
        let incidents = [];
        let clients = [];
        let currentAlarmData = null; // Current alarm transmission data

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Incident Viewer initialized');
            
            // Set default dates (today to 7 days ago)
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 7);
            
            document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
            
            // Load initial data
            loadIncidents();
        });

        // Change site function
        function changeSite(siteName) {
            currentSite = siteName;
            window.location.href = `/incident-viewer?site=${encodeURIComponent(siteName)}`;
        }

        // Load incidents from server
        async function loadIncidents() {
            try {
                showLoading();
                hideError();
                hideNoData();
                
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                if (!startDate || !endDate) {
                    throw new Error('Please select both start and end dates');
                }
                
                console.log(`Loading incidents for ${currentSite} from ${startDate} to ${endDate}`);
                
                // Load incidents
                const incidentsResponse = await fetch('/api/fetch-incidents', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        site: currentSite,
                        start_date: startDate,
                        end_date: endDate
                    })
                });

                if (!incidentsResponse.ok) {
                    if (incidentsResponse.status === 401) {
                        // Session expired - try auto extension
                        console.log('Session expired detected - trying auto extension');
                        const extendResponse = await fetch('/api/extend-session', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        });
                        
                        if (extendResponse.ok) {
                            // Extension successful - retry
                            console.log('Session extension successful - retrying');
                            hideLoading();
                            return loadIncidents();
                        } else {
                            // Extension failed - redirect to login page
                            hideLoading();
                            alert('Session expired. Please login again.');
                            window.location.href = '/';
                            return;
                        }
                    }
                    throw new Error(`HTTP error! status: ${incidentsResponse.status}`);
                }

                const incidentsData = await incidentsResponse.json();
                
                if (!incidentsData.success) {
                    throw new Error(incidentsData.message || 'Failed to load incidents');
                }
                
                incidents = incidentsData.data.incidents || [];
                clients = incidentsData.data.clients || [];
                
                console.log(`Loaded ${incidents.length} incidents and ${clients.length} clients`);
                
                // Debug: Log client data structure
                if (clients.length > 0) {
                    console.log('Sample client data structure:', clients[0]);
                    console.log('Available client fields:', Object.keys(clients[0]));
                }
                
                // Display incidents
                displayIncidents();
                displayStats();
                
            } catch (error) {
                console.error('Error loading incidents:', error);
                showError(error.message);
            } finally {
                hideLoading();
            }
        }

        // Display incidents in the grid
        function displayIncidents() {
            const grid = document.getElementById('incidentGrid');
            
            if (incidents.length === 0) {
                showNoData();
                return;
            }
            
            grid.innerHTML = '';
            
            incidents.forEach(incident => {
                const client = findClientById(incident.ClientId);
                const card = createIncidentCard(incident, client);
                grid.appendChild(card);
            });
        }

        // Create incident card HTML
        function createIncidentCard(incident, client) {
            const card = document.createElement('div');
            const riskClass = getRiskClass(incident.RiskRatingName);
            
            // Change background color for High Risk cases
            if (riskClass === 'risk-high') {
                card.className = 'incident-card high-risk';
            } else {
                card.className = 'incident-card';
            }
            
            const incidentDate = new Date(incident.Date).toLocaleDateString();
            
            card.innerHTML = `
                <div class="incident-header">
                    <div class="incident-title">${incident.EventTypeNames ? incident.EventTypeNames.join(', ') : 'No Event Type'}</div>
                    <div class="incident-date">${incidentDate}</div>
                </div>
                <div class="incident-details">
                    <div class="detail-row">
                        <span class="detail-label">Client:</span>
                        <span class="detail-value">
                            ${client ? 
                                `${formatClientName(client)} (${client.RoomName || 'N/A'})` : 
                                `ID: ${incident.ClientId} (No client data)`
                            }
                        </span>
                    </div>

                    <div class="detail-row">
                        <span class="detail-label">Risk Rating:</span>
                        <span class="detail-value ${riskClass}">${incident.RiskRatingName || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Reported By:</span>
                        <span class="detail-value">${incident.ReportedByName || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Reported Date:</span>
                        <span class="detail-value">${incident.ReportedDate ? new Date(incident.ReportedDate).toLocaleDateString() : 'N/A'}</span>
                    </div>
                    ${incident.Description ? `
                    <div class="detail-row">
                        <span class="detail-label">Description:</span>
                        <span class="detail-value">${incident.Description.substring(0, 200)}${incident.Description.length > 200 ? '...' : ''}</span>
                    </div>
                    ` : ''}
                    ${incident.ActionTaken ? `
                    <div class="detail-row">
                        <span class="detail-label">Action Taken:</span>
                        <span class="detail-value">${incident.ActionTaken.substring(0, 200)}${incident.ActionTaken.length > 200 ? '...' : ''}</span>
                    </div>
                    ` : ''}
                </div>
                
                <!-- Alarm Send Button -->
                <button class="alarm-button ${getRiskClass(incident.RiskRatingName) === 'risk-high' ? 'high-priority' : ''}" onclick="sendAlarmToMobile(${incident.Id}, '${incident.EventTypeNames ? incident.EventTypeNames.join(', ') : 'Incident'}', '${client ? formatClientName(client) : 'Unknown Client'}', '${incident.RiskRatingName || 'Unknown'}')">
                    ${getRiskClass(incident.RiskRatingName) === 'risk-high' ? 'üö® URGENT: Send Alarm' : 'üì± Send Alarm to Mobile'}
                </button>
                
                <!-- Create Workflow Button -->
                <button class="workflow-button" onclick="createWorkflow(${incident.Id}, '${incident.EventTypeNames ? incident.EventTypeNames.join(', ') : 'Incident'}', '${client ? formatClientName(client) : 'Unknown Client'}', ${client ? client.PersonId : 0}, '${incident.RiskRatingName || 'normal'}')">
                    üìã Create Workflow
                </button>
                
                <!-- Alarm Status Display -->
                <div id="alarmStatus_${incident.Id}" class="alarm-status" style="display: none;"></div>
            `;
            
            // Add click event to show popup
            card.addEventListener('click', () => showIncidentPopup(incident, client));
            
            return card;
        }

        // Find client by ID
        function findClientById(clientId) {
            if (!clientId) return null;
            
            // Try matching with multiple ID fields
            const client = clients.find(client => 
                client.PersonId === clientId || 
                client.MainClientServiceId === clientId ||
                client.Id === clientId ||
                client.ClientRecordId === clientId
            );
            
            if (client) {
                console.log(`Client matched for ID ${clientId}:`, client);
            } else {
                console.log(`No client found for ID ${clientId}`);
            }
            
            return client;
        }
        
        // Format client name
        function formatClientName(client) {
            if (!client) return null;
            
            // When FirstName and LastName are available
            if (client.FirstName || client.LastName) {
                const firstName = client.FirstName || '';
                const lastName = client.LastName || '';
                return `${firstName} ${lastName}`.trim();
            }
            
            // When ClientName is available
            if (client.ClientName) {
                return client.ClientName;
            }
            
            // When PreferredName is available
            if (client.PreferredName) {
                return client.PreferredName;
            }
            
            return null;
        }

        // Get risk class for styling
        function getRiskClass(riskRating) {
            if (!riskRating) return '';
            
            const rating = riskRating.toLowerCase();
            if (rating.includes('high') || rating.includes('05') || rating.includes('06') || rating.includes('07') || rating.includes('08') || rating.includes('09') || rating.includes('10')) {
                return 'risk-high';
            } else if (rating.includes('medium') || rating.includes('03') || rating.includes('04')) {
                return 'risk-medium';
            } else {
                return 'risk-low';
            }
        }

        // Display statistics
        function displayStats() {
            const statsSummary = document.getElementById('statsSummary');
            statsSummary.style.display = 'block';
            
            const totalIncidents = incidents.length;
            const highRisk = incidents.filter(i => getRiskClass(i.RiskRatingName) === 'risk-high').length;
            const mediumRisk = incidents.filter(i => getRiskClass(i.RiskRatingName) === 'risk-medium').length;
            const lowRisk = incidents.filter(i => getRiskClass(i.RiskRatingName) === 'risk-low').length;
            
            // Client matching statistics
            const matchedClients = incidents.filter(i => findClientById(i.ClientId)).length;
            const clientMatchRate = totalIncidents > 0 ? Math.round((matchedClients / totalIncidents) * 100) : 0;
            
            document.getElementById('totalIncidents').textContent = totalIncidents;
            document.getElementById('highRiskIncidents').textContent = highRisk;
            document.getElementById('mediumRiskIncidents').textContent = mediumRisk;
            document.getElementById('lowRiskIncidents').textContent = lowRisk;
            
            // Output client matching information to console
            console.log(`Client matching statistics:`);
            console.log(`- Total incidents: ${totalIncidents}`);
            console.log(`- Matched clients: ${matchedClients}`);
            console.log(`- Match rate: ${clientMatchRate}%`);
            
            // Load alarm history
            loadAlarmHistory();
        }

        // UI helper functions
        function showLoading() {
            document.getElementById('loadingIndicator').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loadingIndicator').style.display = 'none';
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            errorText.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        function showNoData() {
            document.getElementById('noDataMessage').style.display = 'block';
        }

        function hideNoData() {
            document.getElementById('noDataMessage').style.display = 'none';
        }
        
        // Popup functions
        function showIncidentPopup(incident, client) {
            const popup = document.getElementById('incidentPopup');
            const popupTitle = document.getElementById('popupTitle');
            const popupDetails = document.getElementById('popupDetails');
            
            // Set popup title
            const eventTypes = incident.EventTypeNames ? incident.EventTypeNames.join(', ') : 'No Event Type';
            const incidentDate = new Date(incident.Date).toLocaleDateString();
            popupTitle.textContent = `${eventTypes} - ${incidentDate}`;
            
            // Build popup content
            let content = '';
            
            // Client information
            content += `
                <div class="popup-detail-row">
                    <div class="popup-detail-label">Client:</div>
                    <div class="popup-detail-value">
                        ${client ? 
                            `${formatClientName(client)} (${client.RoomName || 'N/A'})` : 
                            `ID: ${incident.ClientId} (No client data)`
                        }
                    </div>
                </div>
            `;
            
            // Risk Rating
            content += `
                <div class="popup-detail-row">
                    <div class="popup-detail-label">Risk Rating:</div>
                    <div class="popup-detail-value ${getRiskClass(incident.RiskRatingName)}">
                        ${incident.RiskRatingName || 'N/A'}
                    </div>
                </div>
            `;
            
            // Reported By
            content += `
                <div class="popup-detail-row">
                    <div class="popup-detail-label">Reported By:</div>
                    <div class="popup-detail-value">${incident.ReportedByName || 'N/A'}</div>
                </div>
            `;
            
            // Reported Date
            content += `
                <div class="popup-detail-row">
                    <div class="popup-detail-label">Reported Date:</div>
                    <div class="popup-detail-value">
                        ${incident.ReportedDate ? new Date(incident.ReportedDate).toLocaleDateString() : 'N/A'}
                    </div>
                </div>
            `;
            
            // Full Description (if available)
            if (incident.Description) {
                content += `
                    <div class="popup-detail-row">
                        <div class="popup-detail-label">Description:</div>
                        <div class="popup-detail-value">${incident.Description}</div>
                    </div>
                `;
            }
            
            // Full Action Taken (if available)
            if (incident.ActionTaken) {
                content += `
                    <div class="popup-detail-row">
                        <div class="popup-detail-label">Action Taken:</div>
                        <div class="popup-detail-value">${incident.ActionTaken}</div>
                    </div>
                `;
            }
            
            // Additional fields if available
            if (incident.LocationName) {
                content += `
                    <div class="popup-detail-row">
                        <div class="popup-detail-label">Location:</div>
                        <div class="popup-detail-value">${incident.LocationName}</div>
                    </div>
                `;
            }
            
            if (incident.DepartmentName) {
                content += `
                    <div class="popup-detail-row">
                        <div class="popup-detail-label">Department:</div>
                        <div class="popup-detail-value">${incident.DepartmentName}</div>
                    </div>
                `;
            }
            
            if (incident.WingName) {
                content += `
                    <div class="popup-detail-row">
                        <div class="popup-detail-label">Wing:</div>
                        <div class="popup-detail-value">${incident.WingName}</div>
                    </div>
                `;
            }
            
            if (incident.RoomName) {
                content += `
                    <div class="popup-detail-row">
                        <div class="popup-detail-label">Room:</div>
                        <div class="popup-detail-value">${incident.RoomName}</div>
                    </div>
                `;
            }
            
            // Set content and show popup
            popupDetails.innerHTML = content;
            popup.style.display = 'flex';
            
            // Prevent body scroll when popup is open
            document.body.style.overflow = 'hidden';
        }
        
        function closeIncidentPopup() {
            const popup = document.getElementById('incidentPopup');
            popup.style.display = 'none';
            
            // Restore body scroll
            document.body.style.overflow = 'auto';
        }
        
        // Close popup when clicking outside
        document.addEventListener('click', function(event) {
            const popup = document.getElementById('incidentPopup');
            if (event.target === popup) {
                closeIncidentPopup();
            }
        });
        
        // Close popup with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeIncidentPopup();
                closeAlarmModal();
            }
        });

        // Alarm transmission related functions
        function sendAlarmToMobile(incidentId, eventType, clientName, riskRating) {
            // Stop event propagation (prevent card click)
            event.stopPropagation();
            
            // Save current alarm data
            currentAlarmData = {
                incidentId: incidentId,
                eventType: eventType,
                clientName: clientName,
                site: currentSite,
                riskRating: riskRating, // Add risk level information
                timestamp: new Date().toISOString()
            };
            
            // Set modal message
            const message = `Send alarm for:<br><br>
                <strong>Event:</strong> ${eventType}<br>
                <strong>Client:</strong> ${clientName}<br>
                <strong>Risk Rating:</strong> ${riskRating}<br>
                <strong>Site:</strong> ${currentSite}<br>
                <strong>Time:</strong> ${new Date().toLocaleString()}`;
            
            document.getElementById('alarmModalMessage').innerHTML = message;
            
            // Show modal
            document.getElementById('alarmModal').style.display = 'flex';
            
            // Add event listener to confirm button
            const confirmBtn = document.getElementById('alarmModalConfirm');
            confirmBtn.onclick = () => confirmSendAlarm();
        }

        function confirmSendAlarm() {
            if (!currentAlarmData) return;
            
            const { incidentId, eventType, clientName, site, riskRating, timestamp } = currentAlarmData;
            
            // Î≤ÑÌäº ÏÉÅÌÉú Î≥ÄÍ≤Ω
            const button = document.querySelector(`button[onclick*="sendAlarmToMobile(${incidentId}"]`);
            const statusDiv = document.getElementById(`alarmStatus_${incidentId}`);
            
            if (button && statusDiv) {
                button.className = 'alarm-button sending';
                button.textContent = 'üì§ Sending...';
                button.disabled = true;
                
                statusDiv.className = 'alarm-status sending';
                statusDiv.textContent = 'Sending alarm...';
                statusDiv.style.display = 'block';
            }
            
            // Î™®Îã¨ Îã´Í∏∞
            closeAlarmModal();
            
            // Ïã§Ï†ú ÏïåÎûå Ï†ÑÏÜ° API Ìò∏Ï∂ú
            sendAlarmAPI(incidentId, eventType, clientName, site, riskRating, timestamp);
        }

        async function sendAlarmAPI(incidentId, eventType, clientName, site, riskRating, timestamp) {
            try {
                const alarmData = {
                    incident_id: incidentId,
                    event_type: eventType,
                    client_name: clientName,
                    site: site,
                    timestamp: timestamp,
                    risk_rating: riskRating,
                    priority: riskRating.toLowerCase(), // ÏúÑÌóòÎèÑÏóê Îî∞Îùº Ïö∞ÏÑ†ÏàúÏúÑ ÏÑ§Ï†ï
                    message: `üö® Incident Alert: ${eventType} - ${clientName} at ${site} (Risk: ${riskRating})`,
                    recipients: 'all_staff', // Î™®Îì† ÏßÅÏõêÏóêÍ≤å Ï†ÑÏÜ°
                    category: 'incident'
                };
                
                console.log('Sending alarm:', alarmData);
                
                // ÏïåÎûå Ï†ÑÏÜ° API Ìò∏Ï∂ú (Ïã§Ï†ú Íµ¨ÌòÑ Ïãú Ïù¥ Î∂ÄÎ∂ÑÏùÑ ÏàòÏ†ï)
                const response = await fetch('/api/send-alarm', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(alarmData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        showAlarmSuccess(incidentId, result.message || 'Alarm sent successfully!');
                    } else {
                        throw new Error(result.message || 'Failed to send alarm');
                    }
                } else {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
            } catch (error) {
                console.error('Error sending alarm:', error);
                showAlarmError(incidentId, error.message);
            }
        }

        function showAlarmSuccess(incidentId, message) {
            const button = document.querySelector(`button[onclick*="sendAlarmToMobile(${incidentId}"]`);
            const statusDiv = document.getElementById(`alarmStatus_${incidentId}`);
            
            if (button && statusDiv) {
                button.className = 'alarm-button success';
                button.textContent = '‚úÖ Alarm Sent';
                button.disabled = true;
                
                statusDiv.className = 'alarm-status success';
                statusDiv.textContent = message;
                statusDiv.style.display = 'block';
                
                // 3Ï¥à ÌõÑ Î≤ÑÌäº ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
                setTimeout(() => {
                    button.className = 'alarm-button';
                    button.textContent = 'üì± Send Alarm to Mobile';
                    button.disabled = false;
                    statusDiv.style.display = 'none';
                }, 3000);
            }
            
            // ÏïåÎûå ÌûàÏä§ÌÜ†Î¶¨ ÏÉàÎ°úÍ≥†Ïπ®
            loadAlarmHistory();
        }

        function showAlarmError(incidentId, errorMessage) {
            const button = document.querySelector(`button[onclick*="sendAlarmToMobile(${incidentId}"]`);
            const statusDiv = document.getElementById(`alarmStatus_${incidentId}`);
            
            if (button && statusDiv) {
                button.className = 'alarm-button error';
                button.textContent = '‚ùå Failed';
                button.disabled = true;
                
                statusDiv.className = 'alarm-status error';
                statusDiv.textContent = `Error: ${errorMessage}`;
                statusDiv.style.display = 'block';
                
                // 5Ï¥à ÌõÑ Î≤ÑÌäº ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
                setTimeout(() => {
                    button.className = 'alarm-button';
                    button.textContent = 'üì± Send Alarm to Mobile';
                    button.disabled = false;
                    statusDiv.style.display = 'none';
                }, 5000);
            }
            
            // ÏïåÎûå ÌûàÏä§ÌÜ†Î¶¨ ÏÉàÎ°úÍ≥†Ïπ®
            loadAlarmHistory();
        }

        function closeAlarmModal() {
            document.getElementById('alarmModal').style.display = 'none';
            currentAlarmData = null;
        }

        // ÏïåÎûå ÌûàÏä§ÌÜ†Î¶¨ Î°úÎìú Î∞è ÌëúÏãú
        async function loadAlarmHistory() {
            try {
                const response = await fetch('/api/alarm-history');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        displayAlarmHistory(data.alarms || []);
                    }
                }
            } catch (error) {
                console.error('Error loading alarm history:', error);
            }
        }

        function displayAlarmHistory(alarms) {
            const historyDiv = document.getElementById('alarmHistory');
            const contentDiv = document.getElementById('alarmHistoryContent');
            
            if (alarms.length === 0) {
                historyDiv.style.display = 'none';
                return;
            }
            
            historyDiv.style.display = 'block';
            
            // ÏµúÍ∑º 5Í∞ú ÏïåÎûåÎßå ÌëúÏãú
            const recentAlarms = alarms.slice(-5);
            
            let html = '<div style="display: grid; gap: 15px;">';
            
            recentAlarms.forEach(alarm => {
                const timestamp = new Date(alarm.timestamp).toLocaleString();
                const statusClass = alarm.success ? 'success' : 'error';
                const statusIcon = alarm.success ? '‚úÖ' : '‚ùå';
                
                html += `
                    <div style="background: var(--light-bg); padding: 15px; border-radius: 10px; border-left: 4px solid var(--${statusClass === 'success' ? 'success' : 'accent'}-color);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <strong style="color: var(--primary-color);">${alarm.alarm_data.event_type}</strong>
                            <span style="font-size: 0.9em; color: #7f8c8d;">${timestamp}</span>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <span style="color: var(--dark-text);">${alarm.alarm_data.client_name} at ${alarm.alarm_data.site}</span>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <span style="font-size: 0.9em; color: var(--accent-color); font-weight: 600;">
                                Risk: ${alarm.alarm_data.risk_rating || 'Unknown'}
                            </span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 0.8em; color: #7f8c8d;">Sent by: ${alarm.user}</span>
                            <span style="color: var(--${statusClass === 'success' ? 'success' : 'accent'}-color); font-weight: 600;">
                                ${statusIcon} ${alarm.success ? 'Sent' : 'Failed'}
                            </span>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            contentDiv.innerHTML = html;
        }

        // Î™®Îã¨ Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Îã´Í∏∞
        document.addEventListener('click', function(event) {
            const alarmModal = document.getElementById('alarmModal');
            if (event.target === alarmModal) {
                closeAlarmModal();
            }
        });

        // ==============================
        // Workflow Management Functions
        // ==============================

        // Create workflow for incident
        async function createWorkflow(incidentId, eventType, clientName, clientId, riskRating) {
            try {
                // Stop event propagation (prevent card click)
                event.stopPropagation();
                
                const button = document.querySelector(`button[onclick*="createWorkflow(${incidentId}"]`);
                const originalText = button.textContent;
                
                // Show loading state
                button.textContent = 'üìã Creating...';
                button.classList.add('creating');
                button.disabled = true;
                
                // Prepare workflow data
                const workflowData = {
                    incident_id: incidentId.toString(),
                    policy_id: 1, // Default policy (can be selected later)
                    client_name: clientName,
                    client_id: clientId,
                    site: currentSite,
                    event_type: eventType.toLowerCase(),
                    risk_rating: riskRating.toLowerCase()
                };
                
                console.log('Creating workflow:', workflowData);
                
                // Call workflow creation API
                const response = await fetch('/api/tasks/create-workflow', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(workflowData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Success state
                    button.textContent = '‚úÖ Workflow Created';
                    button.classList.remove('creating');
                    button.classList.add('success');
                    
                    // Show success message
                    showWorkflowStatus(incidentId, `Workflow created successfully! ${result.total_tasks_created} tasks scheduled.`, 'success');
                    
                    console.log('Workflow created successfully:', result);
                    
                    // Reset button after 3 seconds
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.classList.remove('success');
                        button.disabled = false;
                    }, 3000);
                    
                } else {
                    // Error state
                    button.textContent = '‚ùå Creation Failed';
                    button.classList.remove('creating');
                    button.classList.add('error');
                    
                    showWorkflowStatus(incidentId, `Workflow creation failed: ${result.message}`, 'error');
                    
                    // Reset button after 5 seconds
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.classList.remove('error');
                        button.disabled = false;
                    }, 5000);
                }
                
            } catch (error) {
                console.error('Workflow creation error:', error);
                
                const button = document.querySelector(`button[onclick*="createWorkflow(${incidentId}"]`);
                button.textContent = '‚ùå Error';
                button.classList.remove('creating');
                button.classList.add('error');
                
                showWorkflowStatus(incidentId, `Error creating workflow: ${error.message}`, 'error');
                
                // Reset button after 5 seconds
                setTimeout(() => {
                    button.textContent = 'üìã Create Workflow';
                    button.classList.remove('error');
                    button.disabled = false;
                }, 5000);
            }
        }

        // Show workflow status message
        function showWorkflowStatus(incidentId, message, type) {
            const statusDiv = document.getElementById(`alarmStatus_${incidentId}`);
            if (statusDiv) {
                statusDiv.textContent = message;
                statusDiv.className = `alarm-status ${type}`;
                statusDiv.style.display = 'block';
                
                // Hide after 10 seconds
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 10000);
            }
        }

        // ==============================
        // Í≥†Í∏â ÏïåÎûå Í¥ÄÎ¶¨ Í∏∞Îä•
        // ==============================

        // Í≥†Í∏â ÏïåÎûå Ìå®ÎÑê ÌÜ†Í∏Ä
        function toggleAdvancedAlarmPanel() {
            const panel = document.getElementById('advancedAlarmPanel');
            const btn = document.getElementById('toggleAdvancedPanelBtn');
            
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                btn.textContent = '‚öôÔ∏è Hide Advanced Alarm Management';
                loadAdvancedAlarmData();
            } else {
                panel.style.display = 'none';
                btn.textContent = '‚öôÔ∏è Show Advanced Alarm Management';
            }
        }

        // Í≥†Í∏â ÏïåÎûå Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        async function loadAdvancedAlarmData() {
            await Promise.all([
                loadAlarmTemplates(),
                loadAlarmRecipients(),
                loadEscalationStatus()
            ]);
        }

        // ÏïåÎûå ÌÖúÌîåÎ¶ø Î°úÎìú
        async function loadAlarmTemplates() {
            try {
                const response = await fetch('/api/alarm-templates');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        displayAlarmTemplates(data.templates || []);
                    }
                }
            } catch (error) {
                console.error('Error loading alarm templates:', error);
            }
        }

        // ÏïåÎûå ÌÖúÌîåÎ¶ø ÌëúÏãú
        function displayAlarmTemplates(templates) {
            const contentDiv = document.getElementById('alarmTemplatesContent');
            
            if (templates.length === 0) {
                contentDiv.innerHTML = '<p style="color: #7f8c8d; font-style: italic;">No templates available</p>';
                return;
            }
            
            let html = '<div style="display: grid; gap: 10px;">';
            
            templates.forEach(template => {
                const priorityClass = `priority-${template.priority}`;
                const escalationIcon = template.escalation_enabled ? 'üö®' : '‚úÖ';
                
                html += `
                    <div style="background: var(--light-bg); padding: 12px; border-radius: 8px; border-left: 4px solid var(--${template.priority === 'urgent' ? 'accent' : template.priority === 'high' ? 'warning' : template.priority === 'normal' ? 'secondary' : 'success'}-color);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <strong style="color: var(--primary-color);">${template.name}</strong>
                            <span style="font-size: 0.8em; color: #7f8c8d;">${template.category}</span>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <span style="color: var(--dark-text);">${template.title}</span>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <span style="font-size: 0.9em; color: var(--dark-text);">${template.body}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 0.8em; color: var(--${template.priority === 'urgent' ? 'accent' : template.priority === 'high' ? 'warning' : template.priority === 'normal' ? 'secondary' : 'success'}-color); font-weight: 600;">
                                ${template.priority.toUpperCase()}
                            </span>
                            <span style="font-size: 0.8em; color: #7f8c8d;">
                                ${escalationIcon} ${template.escalation_enabled ? 'Escalation Enabled' : 'No Escalation'}
                            </span>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            contentDiv.innerHTML = html;
        }

        // ÏàòÏã†Ïûê Î°úÎìú
        async function loadAlarmRecipients() {
            try {
                const response = await fetch('/api/alarm-recipients');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        displayAlarmRecipients(data.recipients || []);
                    }
                }
            } catch (error) {
                console.error('Error loading alarm recipients:', error);
            }
        }

        // ÏàòÏã†Ïûê ÌëúÏãú
        function displayAlarmRecipients(recipients) {
            const contentDiv = document.getElementById('alarmRecipientsContent');
            
            if (recipients.length === 0) {
                contentDiv.innerHTML = '<p style="color: #7f8c8d; font-style: italic;">No recipients available</p>';
                return;
            }
            
            let html = '<div style="display: grid; gap: 10px;">';
            
            recipients.forEach(recipient => {
                const statusIcon = recipient.is_active ? 'üü¢' : 'üî¥';
                const fcmStatus = recipient.fcm_token ? 'üì± FCM Active' : 'üì± No FCM Token';
                
                html += `
                    <div style="background: var(--light-bg); padding: 12px; border-radius: 8px; border-left: 4px solid var(--${recipient.is_active ? 'success' : 'accent'}-color);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <strong style="color: var(--primary-color);">${recipient.name}</strong>
                            <span style="font-size: 0.8em; color: #7f8c8d;">${recipient.role}</span>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <span style="color: var(--dark-text);">${recipient.email}</span>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <span style="font-size: 0.9em; color: var(--dark-text);">${recipient.phone}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 0.8em; color: var(--${recipient.is_active ? 'success' : 'accent'}-color);">
                                ${statusIcon} ${recipient.is_active ? 'Active' : 'Inactive'}
                            </span>
                            <span style="font-size: 0.8em; color: #7f8c8d;">
                                ${fcmStatus}
                            </span>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            contentDiv.innerHTML = html;
        }

        // ÏóêÏä§Ïª¨Î†àÏù¥ÏÖò ÏÉÅÌÉú Î°úÎìú
        async function loadEscalationStatus() {
            try {
                const response = await fetch('/api/alarms/escalations');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        displayEscalationStatus(data.pending_escalations_count);
                    }
                }
            } catch (error) {
                console.error('Error loading escalation status:', error);
            }
        }

        // ÏóêÏä§Ïª¨Î†àÏù¥ÏÖò ÏÉÅÌÉú ÌëúÏãú
        function displayEscalationStatus(pendingCount) {
            const contentDiv = document.getElementById('escalationStatusContent');
            
            const statusClass = pendingCount > 0 ? 'warning' : 'success';
            const statusIcon = pendingCount > 0 ? 'üö®' : '‚úÖ';
            
            contentDiv.innerHTML = `
                <div style="background: var(--light-bg); padding: 15px; border-radius: 8px; border-left: 4px solid var(--${statusClass}-color);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: 600; color: var(--primary-color);">Pending Escalations</span>
                        <span style="font-size: 1.2em; color: var(--${statusClass}-color); font-weight: 600;">
                            ${statusIcon} ${pendingCount}
                        </span>
                    </div>
                    <p style="margin-top: 10px; color: var(--dark-text); font-size: 0.9em;">
                        ${pendingCount > 0 ? 'Some alarms require immediate attention' : 'All alarms are properly managed'}
                    </p>
                </div>
            `;
        }

        // ÌÖúÌîåÎ¶ø ÏÉùÏÑ± Î™®Îã¨ ÌëúÏãú
        function showCreateTemplateModal() {
            document.getElementById('templateModal').style.display = 'block';
            
            // ÏóêÏä§Ïª¨Î†àÏù¥ÏÖò Ï≤¥ÌÅ¨Î∞ïÏä§ Ïù¥Î≤§Ìä∏
            document.getElementById('templateEscalation').addEventListener('change', function() {
                const delayDiv = document.getElementById('escalationDelayDiv');
                delayDiv.style.display = this.checked ? 'block' : 'none';
            });
        }

        // ÌÖúÌîåÎ¶ø ÏÉùÏÑ±
        async function createTemplate() {
            try {
                const formData = {
                    name: document.getElementById('templateName').value,
                    title: document.getElementById('templateTitle').value,
                    body: document.getElementById('templateBody').value,
                    priority: document.getElementById('templatePriority').value,
                    category: document.getElementById('templateCategory').value,
                    escalation_enabled: document.getElementById('templateEscalation').checked,
                    escalation_delay_minutes: document.getElementById('templateEscalationDelay').value
                };
                
                const response = await fetch('/api/alarm-templates', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        alert('Template created successfully!');
                        closeTemplateModal();
                        loadAlarmTemplates();
                    } else {
                        alert('Failed to create template: ' + data.message);
                    }
                } else {
                    alert('Failed to create template');
                }
            } catch (error) {
                console.error('Error creating template:', error);
                alert('Error creating template');
            }
        }

        // ÌÖúÌîåÎ¶ø Î™®Îã¨ Îã´Í∏∞
        function closeTemplateModal() {
            document.getElementById('templateModal').style.display = 'none';
            document.getElementById('templateForm').reset();
        }

        // ÏàòÏã†Ïûê Ï∂îÍ∞Ä Î™®Îã¨ ÌëúÏãú
        function showAddRecipientModal() {
            document.getElementById('recipientModal').style.display = 'block';
        }

        // ÏàòÏã†Ïûê Ï∂îÍ∞Ä
        async function addRecipient() {
            try {
                const formData = {
                    user_id: document.getElementById('recipientUserId').value,
                    name: document.getElementById('recipientName').value,
                    email: document.getElementById('recipientEmail').value,
                    phone: document.getElementById('recipientPhone').value,
                    role: document.getElementById('recipientRole').value,
                    team: document.getElementById('recipientTeam').value
                };
                
                const response = await fetch('/api/alarm-recipients', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        alert('Recipient added successfully!');
                        closeRecipientModal();
                        loadAlarmRecipients();
                    } else {
                        alert('Failed to add recipient: ' + data.message);
                    }
                } else {
                    alert('Failed to add recipient');
                }
            } catch (error) {
                console.error('Error adding recipient:', error);
                alert('Error adding recipient');
            }
        }

        // ÏàòÏã†Ïûê Î™®Îã¨ Îã´Í∏∞
        function closeRecipientModal() {
            document.getElementById('recipientModal').style.display = 'none';
            document.getElementById('recipientForm').reset();
        }

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Í≥†Í∏â ÏïåÎûå Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        document.addEventListener('DOMContentLoaded', function() {
            // Í∏∞Ï°¥ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑàÎì§...
            
            // ÏóêÏä§Ïª¨Î†àÏù¥ÏÖò Ï≤¥ÌÅ¨Î∞ïÏä§ Ïù¥Î≤§Ìä∏
            document.getElementById('templateEscalation').addEventListener('change', function() {
                const delayDiv = document.getElementById('escalationDelayDiv');
                delayDiv.style.display = this.checked ? 'block' : 'none';
            });
        });
    </script>
</body>
</html>
