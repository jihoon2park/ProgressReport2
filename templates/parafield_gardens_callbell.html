<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Edenfield Parafield Gardens | Callbell Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #020617; color: white; overflow: hidden; font-family: system-ui, -apple-system, sans-serif; }
        #call-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
            padding: 12px;
        }
        .card {
            will-change: transform;
            transition: background-color 0.4s ease, border-color 0.4s ease, transform 0.2s ease-out;
        }
        .card-red { animation: pulse-red 1s infinite; }
        @keyframes pulse-red {
            0%, 100% { background-color: #450a0a; }
            50% { background-color: #991b1b; }
        }
        .timer-font { font-family: 'Courier New', Courier, monospace; font-variant-numeric: tabular-nums; }
        .room-text { font-size: clamp(1.25rem, 3vw, 1.75rem); line-height: 1.2; word-break: break-word; text-transform: uppercase; }
        .settings-panel {
            max-height: 0; overflow: hidden;
            transition: max-height 0.35s ease, padding 0.35s ease, opacity 0.25s ease;
            opacity: 0;
        }
        .settings-panel.open { max-height: 220px; opacity: 1; }
        .threshold-card {
            display: flex; flex-direction: column; align-items: center; gap: 6px;
            padding: 12px 20px; border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.08);
            background: rgba(255,255,255,0.03);
        }
        .threshold-input {
            width: 64px; text-align: center; font-weight: 800; font-size: 1.25rem;
            background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.15);
            border-radius: 8px; color: white; padding: 6px 0;
            outline: none; transition: border-color 0.2s;
        }
        .threshold-input:focus { border-color: rgba(255,255,255,0.4); }
    </style>
</head>
<body class="h-screen flex flex-col">
    <!-- Header -->
    <header class="px-5 py-3 bg-slate-900/90 border-b border-slate-800 flex justify-between items-center shadow-xl backdrop-blur-sm">
        <h1 class="text-xl font-black uppercase tracking-tighter">
            <span class="text-teal-400">Edenfield</span> Parafield Gardens
        </h1>
        <div class="flex items-center gap-3">
            <!-- Admin-only controls (hidden by default, shown after auth check) -->
            <div id="admin-controls" class="hidden flex items-center gap-3">
                <button id="settings-toggle" onclick="toggleSettings()"
                    class="px-4 py-1.5 bg-slate-700 hover:bg-slate-600 text-white text-xs font-bold uppercase rounded transition-colors flex items-center gap-1.5">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><circle cx="12" cy="12" r="3"/></svg>
                    Settings
                </button>
                <button id="timer-on-btn" onclick="toggleTimer(true)"
                    class="px-4 py-1.5 bg-slate-600 hover:bg-slate-700 text-white text-xs font-bold uppercase rounded transition-colors">Timer ON</button>
                <button id="timer-off-btn" onclick="toggleTimer(false)"
                    class="px-4 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold uppercase rounded transition-colors">Timer OFF</button>
                <button onclick="resetCalls()"
                    class="px-4 py-1.5 bg-red-600 hover:bg-red-700 text-white text-xs font-bold uppercase rounded transition-colors">Reset All</button>
            </div>
            <div id="clock" class="text-2xl font-bold text-slate-400 tabular-nums ml-2" style="font-variant-numeric: tabular-nums;">00:00:00</div>
        </div>
    </header>

    <!-- Settings Panel (hidden by default, admin only) -->
    <div id="settings-panel" class="settings-panel bg-slate-900/95 border-b border-slate-700/50 backdrop-blur-xl">
        <div class="px-5 py-4">
            <div class="flex items-center justify-between mb-3">
                <h2 class="text-sm font-black uppercase tracking-wide text-slate-300">Color Threshold Settings</h2>
                <div class="flex items-center gap-2">
                    <span id="save-status" class="text-xs text-slate-500 hidden">Saved</span>
                    <button onclick="saveSettings()"
                        class="px-5 py-1.5 bg-teal-600 hover:bg-teal-500 text-white text-xs font-bold uppercase rounded transition-colors">
                        Save Changes
                    </button>
                </div>
            </div>
            <div class="flex items-start gap-4">
                <div class="threshold-card">
                    <div class="w-4 h-4 rounded-full" style="background:#22c55e; box-shadow: 0 0 8px #22c55e88;"></div>
                    <span class="text-[10px] font-bold uppercase text-slate-400 tracking-wider">Green Alert</span>
                    <div class="flex items-center gap-1">
                        <input id="set-green" type="number" min="1" max="59" value="3" class="threshold-input" style="color: #86efac;">
                        <span class="text-xs text-slate-500 font-bold">min</span>
                    </div>
                </div>
                <div class="threshold-card">
                    <div class="w-4 h-4 rounded-full" style="background:#d97706; box-shadow: 0 0 8px #d9770688;"></div>
                    <span class="text-[10px] font-bold uppercase text-slate-400 tracking-wider">Yellow Alert</span>
                    <div class="flex items-center gap-1">
                        <input id="set-yellow" type="number" min="1" max="59" value="5" class="threshold-input" style="color: #fcd34d;">
                        <span class="text-xs text-slate-500 font-bold">min</span>
                    </div>
                </div>
                <div class="threshold-card">
                    <div class="w-4 h-4 rounded-full" style="background:#f87171; box-shadow: 0 0 8px #f8717188;"></div>
                    <span class="text-[10px] font-bold uppercase text-slate-400 tracking-wider">Red Alert</span>
                    <div class="flex items-center gap-1">
                        <input id="set-red" type="number" min="1" max="59" value="7" class="threshold-input" style="color: #fca5a5;">
                        <span class="text-xs text-slate-500 font-bold">min</span>
                    </div>
                </div>
                <div class="flex-1 flex items-center">
                    <div class="text-[11px] text-slate-500 leading-relaxed pl-4 border-l border-slate-700/50">
                        <div class="mb-1"><span class="text-yellow-400 font-bold">Assist</span> calls always start from <span class="text-yellow-400 font-bold">Yellow</span></div>
                        <div><span class="text-red-400 font-bold">Emergency</span> calls are always <span class="text-red-400 font-bold">Red</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto">
        <div id="call-grid"></div>
        <div id="no-calls" class="fixed inset-0 flex items-center justify-center opacity-5 pointer-events-none hidden">
            <h2 class="text-9xl font-black italic">CLEAR</h2>
        </div>
    </main>

    <script>
        const grid = document.getElementById('call-grid');
        const empty = document.getElementById('no-calls');
        const SITE_ID = 'parafield_gardens';
        let timerEnabled = false;
        let isAdmin = false;

        // ── Auth Check ──
        const checkAuth = async () => {
            try {
                const res = await fetch('/api/callbell/auth');
                const data = await res.json();
                if (data.is_admin) {
                    isAdmin = true;
                    document.getElementById('admin-controls').classList.remove('hidden');
                    document.getElementById('admin-controls').classList.add('flex');
                    loadSettings();
                    // Admin: load timer pref from localStorage, default ON
                    const saved = localStorage.getItem('callbell_timer_enabled');
                    timerEnabled = saved !== null ? saved === 'true' : true;
                    toggleTimer(timerEnabled);
                } else {
                    // Not admin: timer OFF, no controls
                    timerEnabled = false;
                    toggleTimer(false);
                }
            } catch (e) {
                console.warn('Auth check failed:', e);
                timerEnabled = false;
                toggleTimer(false);
            }
        };

        // ── Settings Panel ──
        const toggleSettings = () => {
            document.getElementById('settings-panel').classList.toggle('open');
        };

        const loadSettings = async () => {
            try {
                const res = await fetch('/api/callbell/settings');
                const data = await res.json();
                const s = data.settings || {};
                document.getElementById('set-green').value = s.green_minutes || 3;
                document.getElementById('set-yellow').value = s.yellow_minutes || 5;
                document.getElementById('set-red').value = s.red_minutes || 7;
            } catch (e) { console.warn('Failed to load settings:', e); }
        };

        const saveSettings = async () => {
            const green = parseInt(document.getElementById('set-green').value);
            const yellow = parseInt(document.getElementById('set-yellow').value);
            const red = parseInt(document.getElementById('set-red').value);

            if (!(green < yellow && yellow < red && green > 0)) {
                alert('Thresholds must be: Green < Yellow < Red (all > 0)');
                return;
            }

            try {
                const res = await fetch('/api/callbell/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ green_minutes: green, yellow_minutes: yellow, red_minutes: red })
                });
                const data = await res.json();
                if (data.status === 'ok') {
                    const status = document.getElementById('save-status');
                    status.classList.remove('hidden');
                    status.textContent = 'Saved!';
                    status.className = 'text-xs text-green-400 font-bold';
                    setTimeout(() => { status.classList.add('hidden'); }, 2000);
                    _prevJson = '';
                    pollCalls();
                } else {
                    alert(data.message || 'Failed to save');
                }
            } catch (e) { alert('Error saving settings'); }
        };

        // ── Timer Toggle ──
        const toggleTimer = (enabled) => {
            timerEnabled = enabled;
            if (isAdmin) localStorage.setItem('callbell_timer_enabled', enabled);
            const onBtn = document.getElementById('timer-on-btn');
            const offBtn = document.getElementById('timer-off-btn');
            if (onBtn && offBtn) {
                if (enabled) {
                    onBtn.className = 'px-4 py-1.5 bg-green-600 hover:bg-green-700 text-white text-xs font-bold uppercase rounded transition-colors';
                    offBtn.className = 'px-4 py-1.5 bg-slate-600 hover:bg-slate-700 text-white text-xs font-bold uppercase rounded transition-colors';
                } else {
                    onBtn.className = 'px-4 py-1.5 bg-slate-600 hover:bg-slate-700 text-white text-xs font-bold uppercase rounded transition-colors';
                    offBtn.className = 'px-4 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold uppercase rounded transition-colors';
                }
            }
            const timers = document.getElementsByClassName('timer-font');
            for (let i = 0; i < timers.length; i++) {
                timers[i].style.display = enabled ? 'block' : 'none';
            }
        };

        // Init: timer OFF by default (auth check will enable for admins)
        toggleTimer(false);
        checkAuth();

        // ── Clock ──
        setInterval(() => {
            document.getElementById('clock').textContent = new Date().toLocaleTimeString('en-GB');
        }, 1000);

        // ── Render Cards (colors from backend) ──
        const syncUI = (data) => {
            let card = document.getElementById(`room-${data.room}`);
            if (!card) {
                card = document.createElement('div');
                card.id = `room-${data.room}`;
                grid.appendChild(card);
            }

            const isRed = data.card_level === 'red';
            card.className = `card p-4 rounded-xl shadow-lg flex flex-col justify-between ${isRed ? 'card-red' : ''}`;
            card.style.backgroundColor = isRed ? '' : data.card_bg;
            card.style.borderWidth = '2px';
            card.style.borderStyle = 'solid';
            card.style.borderColor = data.card_border;
            card.dataset.priority = data.priority;
            card.dataset.start = data.start;
            card.dataset.level = data.card_level;

            const label = data.messageText || data.room;

            card.innerHTML = `
                <div class="room-text font-black">${label}</div>
                <div class="flex justify-end items-end mt-3">
                    <div class="text-4xl font-bold timer-font tabular-nums" data-start="${data.start}" style="display: ${timerEnabled ? 'block' : 'none'}; color: ${data.card_text || '#94a3b8'}">00:00</div>
                </div>
            `;
        };

        const sortGrid = () => {
            const children = Array.from(grid.children);
            if (children.length === 0) { empty.classList.remove('hidden'); return; }
            empty.classList.add('hidden');
            const levelOrder = { red: 0, yellow: 1, green: 2, gray: 3 };
            children.sort((a, b) => (levelOrder[a.dataset.level] || 3) - (levelOrder[b.dataset.level] || 3) || parseFloat(a.dataset.start) - parseFloat(b.dataset.start));
            const fragment = document.createDocumentFragment();
            children.forEach(child => fragment.appendChild(child));
            grid.appendChild(fragment);
        };

        // ── Poll API ──
        let _prevJson = '';
        const pollCalls = async () => {
            try {
                const res = await fetch(`/api/callbell/${SITE_ID}/active`);
                const data = await res.json();
                const calls = data.calls || [];
                const json = JSON.stringify(calls);
                if (json === _prevJson) return;
                _prevJson = json;
                const serverRooms = new Set(calls.map(c => c.room));
                Array.from(grid.children).forEach(card => {
                    const roomId = card.id.replace('room-', '');
                    if (!serverRooms.has(roomId)) card.remove();
                });
                calls.forEach(syncUI);
                sortGrid();
            } catch (e) { console.warn('Poll failed:', e); }
        };
        pollCalls();
        setInterval(pollCalls, 2000);

        // ── Reset ──
        const resetCalls = async () => {
            if (!confirm('Clear all active calls?')) return;
            await fetch(`/api/callbell/${SITE_ID}/reset`, { method: 'POST' });
            grid.innerHTML = '';
            _prevJson = '';
            pollCalls();
        };

        // ── Timer (requestAnimationFrame) ──
        const runTimers = () => {
            const now = Math.floor(Date.now() / 1000);
            const timers = document.getElementsByClassName('timer-font');
            for (let i = 0; i < timers.length; i++) {
                const start = Math.floor(parseFloat(timers[i].dataset.start));
                const diff = now - start;
                const m = (diff / 60 | 0).toString().padStart(2, '0');
                const s = (diff % 60).toString().padStart(2, '0');
                const t = `${m}:${s}`;
                if (timers[i].textContent !== t) timers[i].textContent = t;
            }
            requestAnimationFrame(runTimers);
        };
        requestAnimationFrame(runTimers);
    </script>
</body>
</html>
