<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>CIMS - Task Completion Confirmation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #17a2b8;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 1rem;
        }

        .confirmation-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-top: 2rem;
        }

        .card-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .card-header h2 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .card-header .subtitle {
            margin-top: 0.5rem;
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .card-body {
            padding: 2rem;
        }

        .task-context {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border-left: 5px solid var(--secondary-color);
        }

        .task-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .task-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }

        .detail-item {
            text-align: center;
        }

        .detail-label {
            font-size: 0.8rem;
            color: #6c757d;
            margin-bottom: 0.3rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-value {
            font-weight: bold;
            color: var(--primary-color);
        }

        .resident-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: #e3f2fd;
            border-radius: 10px;
            margin-bottom: 2rem;
        }

        .resident-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--secondary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .resident-details h4 {
            margin: 0;
            color: var(--primary-color);
        }

        .resident-details p {
            margin: 0.2rem 0 0 0;
            color: #6c757d;
            font-size: 0.9rem;
        }

        .warning-banner {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border: 2px solid var(--warning-color);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        .warning-banner .icon {
            font-size: 2rem;
            color: var(--warning-color);
            margin-bottom: 0.5rem;
        }

        .warning-banner h4 {
            color: #856404;
            margin-bottom: 0.5rem;
        }

        .warning-banner p {
            color: #856404;
            margin: 0;
            font-size: 0.9rem;
        }

        .manad-action {
            background: #e8f5e8;
            border-radius: 15px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 2rem;
        }

        .btn-manad {
            background: linear-gradient(135deg, var(--success-color), #2ecc71);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: bold;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
        }

        .btn-manad:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(46, 204, 113, 0.4);
            color: white;
        }

        .btn-policy {
            background: var(--info-color);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 20px;
            font-size: 0.9rem;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s;
            margin-top: 1rem;
        }

        .btn-policy:hover {
            background: #138496;
            color: white;
            transform: translateY(-1px);
        }

        .compliance-time {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
            margin-bottom: 2rem;
        }

        .time-label {
            font-size: 0.8rem;
            color: #6c757d;
            margin-bottom: 0.5rem;
        }

        .time-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-color);
            font-family: 'Courier New', monospace;
        }

        .confirmation-section {
            background: #fff5f5;
            border: 2px solid #ffebee;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .confirmation-checkbox {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .confirmation-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-top: 0.2rem;
            accent-color: var(--success-color);
        }

        .confirmation-text {
            flex: 1;
            font-size: 0.95rem;
            line-height: 1.5;
            color: var(--primary-color);
        }

        .completer-info {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
        }

        .completer-label {
            font-size: 0.8rem;
            color: #6c757d;
            margin-bottom: 0.3rem;
        }

        .completer-name {
            font-weight: bold;
            color: var(--primary-color);
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 2rem;
        }

        .btn-confirm {
            background: linear-gradient(135deg, var(--success-color), #2ecc71);
            color: white;
            border: none;
            padding: 1rem;
            border-radius: 15px;
            font-size: 1.1rem;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }

        .btn-confirm:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4);
        }

        .btn-confirm:disabled {
            background: #6c757d;
            cursor: not-allowed;
            box-shadow: none;
        }

        .btn-cancel {
            background: #6c757d;
            color: white;
            border: none;
            padding: 1rem;
            border-radius: 15px;
            font-size: 1.1rem;
            font-weight: bold;
            transition: all 0.3s;
        }

        .btn-cancel:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .offline-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--warning-color);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            z-index: 1000;
            display: none;
        }

        .offline-indicator.show {
            display: block;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            display: none;
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            text-align: center;
            max-width: 300px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--secondary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container {
                padding: 0.5rem;
            }
            
            .confirmation-card {
                margin-top: 1rem;
            }
            
            .task-details {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            
            .action-buttons {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Offline Indicator -->
    <div class="offline-indicator" id="offlineIndicator">
        <i class="fas fa-wifi-slash me-2"></i>
        Offline Mode
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <p>Confirming task completion...</p>
        </div>
    </div>

    <div class="container">
        <div class="confirmation-card">
            <!-- Header -->
            <div class="card-header">
                <h2><i class="fas fa-check-circle me-2"></i>Task Completion Confirmation</h2>
                <div class="subtitle">Confirm that the required action has been completed in MANAD Plus</div>
            </div>

            <div class="card-body">
                <!-- Task Context -->
                <div class="task-context">
                    <div class="task-title" id="taskTitle">Post Fall Assessment & Vitals</div>
                    <div class="task-details">
                        <div class="detail-item">
                            <div class="detail-label">Due Date</div>
                            <div class="detail-value" id="taskDueDate">2025-10-02 10:30</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Priority</div>
                            <div class="detail-value" id="taskPriority">High</div>
                        </div>
                    </div>
                </div>

                <!-- Resident Context -->
                <div class="resident-info">
                    <div class="resident-avatar" id="residentAvatar">KS</div>
                    <div class="resident-details">
                        <h4 id="residentName">Kim, Chul-soo</h4>
                        <p><i class="fas fa-door-open me-1"></i>Room <span id="residentRoom">305</span></p>
                        <p><i class="fas fa-id-card me-1"></i>ID: <span id="residentId">RES-12345</span></p>
                    </div>
                </div>

                <!-- Warning Banner -->
                <div class="warning-banner">
                    <div class="icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h4>⚠️ ACTION REQUIRED IN MANAD PLUS FIRST</h4>
                    <p>You must complete the required Progress Note in MANAD Plus before confirming completion here.</p>
                </div>

                <!-- MANAD Plus Action -->
                <div class="manad-action">
                    <h5 class="mb-3">Step 1: Complete Progress Note</h5>
                    <p class="mb-3">Please navigate to MANAD Plus, complete the required Progress Note, and then return here to confirm completion.</p>
                    
                    <a href="#" class="btn-manad" id="manadButton" onclick="openMANADPlus()">
                        <i class="fas fa-external-link-alt me-2"></i>
                        GO TO MANAD PLUS
                    </a>
                    
                    <br>
                    <a href="#" class="btn-policy" onclick="viewPolicy()">
                        <i class="fas fa-book me-2"></i>
                        View Policy Step
                    </a>
                </div>

                <!-- Compliance Time -->
                <div class="compliance-time">
                    <div class="time-label">Completion Time (Device Local Time)</div>
                    <div class="time-value" id="currentTime">2025-10-02 09:45:30</div>
                </div>

                <!-- Confirmation Section -->
                <div class="confirmation-section">
                    <h5 class="mb-3">Step 2: Confirm Completion</h5>
                    
                    <div class="confirmation-checkbox">
                        <input type="checkbox" id="confirmationCheck" onchange="toggleConfirmButton()">
                        <label for="confirmationCheck" class="confirmation-text">
                            <strong>I confirm that the required Progress Note has been fully completed and submitted in MANAD Plus.</strong>
                            <br><small class="text-muted">This confirmation will be recorded in the audit log for compliance purposes.</small>
                        </label>
                    </div>

                    <div class="completer-info">
                        <div class="completer-label">Confirming User</div>
                        <div class="completer-name" id="completerName">{{ current_user.display_name if current_user else 'RN-JANE-DOE' }}</div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn-cancel" onclick="cancelConfirmation()">
                        <i class="fas fa-times me-2"></i>
                        Cancel
                    </button>
                    <button class="btn-confirm" id="confirmButton" onclick="confirmCompletion()" disabled>
                        <i class="fas fa-check me-2"></i>
                        CONFIRM COMPLETION & CLOSE TASK
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let taskData = null;
        let isOnline = navigator.onLine;
        let offlineConfirmations = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadTaskData();
            updateCurrentTime();
            checkOnlineStatus();
            
            // Update time every second
            setInterval(updateCurrentTime, 1000);
            
            // Check online status every 5 seconds
            setInterval(checkOnlineStatus, 5000);
        });

        // Load task data from URL parameters or API
        function loadTaskData() {
            const urlParams = new URLSearchParams(window.location.search);
            const taskId = urlParams.get('task_id');
            
            if (taskId) {
                fetchTaskData(taskId);
            } else {
                // Use mock data for demo
                taskData = {
                    task_id: 'T-001',
                    title: 'Post Fall Assessment & Vitals',
                    due_date: '2025-10-02T10:30:00Z',
                    priority: 'High',
                    resident: {
                        name: 'Kim, Chul-soo',
                        room: '305',
                        id: 'RES-12345'
                    }
                };
                updateUI();
            }
        }

        // Fetch task data from API
        async function fetchTaskData(taskId) {
            try {
                const response = await fetch(`/api/v1/tasks/${taskId}`);
                if (response.ok) {
                    taskData = await response.json();
                    updateUI();
                } else {
                    throw new Error('Failed to load task data');
                }
            } catch (error) {
                console.error('Error loading task data:', error);
                alert('Failed to load task information');
            }
        }

        // Update UI with task data
        function updateUI() {
            if (!taskData) return;

            document.getElementById('taskTitle').textContent = taskData.title;
            document.getElementById('taskDueDate').textContent = formatDateTime(taskData.due_date);
            document.getElementById('taskPriority').textContent = taskData.priority;
            
            if (taskData.resident) {
                document.getElementById('residentName').textContent = taskData.resident.name;
                document.getElementById('residentRoom').textContent = taskData.resident.room;
                document.getElementById('residentId').textContent = taskData.resident.id;
                
                // Set avatar initials
                const initials = taskData.resident.name.split(' ').map(n => n[0]).join('');
                document.getElementById('residentAvatar').textContent = initials;
            }
        }

        // Update current time display
        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('currentTime').textContent = timeString;
        }

        // Check online status
        function checkOnlineStatus() {
            const wasOnline = isOnline;
            isOnline = navigator.onLine;
            
            if (wasOnline !== isOnline) {
                const indicator = document.getElementById('offlineIndicator');
                if (isOnline) {
                    indicator.classList.remove('show');
                    syncOfflineConfirmations();
                } else {
                    indicator.classList.add('show');
                }
            }
        }

        // Toggle confirm button based on checkbox
        function toggleConfirmButton() {
            const checkbox = document.getElementById('confirmationCheck');
            const button = document.getElementById('confirmButton');
            
            button.disabled = !checkbox.checked;
        }

        // Open MANAD Plus (deeplink or new tab)
        function openMANADPlus() {
            // Try deeplink first (mobile app)
            const deeplink = `manadplus://incident/${taskData?.incident_id || 'unknown'}`;
            
            // For mobile devices, try the deeplink
            if (/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                window.location.href = deeplink;
                
                // Fallback to web version after a delay
                setTimeout(() => {
                    window.open('https://manadplus.com/incidents', '_blank');
                }, 2000);
            } else {
                // Desktop: open web version
                window.open('https://manadplus.com/incidents', '_blank');
            }
        }

        // View policy details
        function viewPolicy() {
            alert('Policy details would be shown here');
        }

        // Confirm task completion
        async function confirmCompletion() {
            const checkbox = document.getElementById('confirmationCheck');
            
            if (!checkbox.checked) {
                alert('Please confirm that you have completed the required action in MANAD Plus');
                return;
            }

            const confirmationData = {
                task_id: taskData?.task_id,
                confirmed_at: new Date().toISOString(),
                confirmed_by: document.getElementById('completerName').textContent,
                confirmation_type: 'manad_plus_completion'
            };

            if (isOnline) {
                await submitConfirmation(confirmationData);
            } else {
                saveOfflineConfirmation(confirmationData);
            }
        }

        // Submit confirmation to server
        async function submitConfirmation(confirmationData) {
            try {
                showLoading(true);
                
                const response = await fetch(`/api/v1/tasks/${confirmationData.task_id}/confirm-completion`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(confirmationData)
                });

                if (response.ok) {
                    const result = await response.json();
                    alert('Task completion confirmed successfully!');
                    
                    // Redirect back to dashboard
                    window.location.href = '/mobile_dashboard';
                } else {
                    throw new Error('Failed to confirm completion');
                }
            } catch (error) {
                console.error('Error confirming completion:', error);
                alert('Failed to confirm completion. Please try again.');
            } finally {
                showLoading(false);
            }
        }

        // Save confirmation for offline sync
        function saveOfflineConfirmation(confirmationData) {
            offlineConfirmations.push(confirmationData);
            localStorage.setItem('cims_offline_confirmations', JSON.stringify(offlineConfirmations));
            
            alert('Confirmation saved offline. It will be synced when connection is restored.');
            window.location.href = '/mobile_dashboard';
        }

        // Sync offline confirmations when online
        async function syncOfflineConfirmations() {
            const stored = localStorage.getItem('cims_offline_confirmations');
            if (!stored) return;

            const confirmations = JSON.parse(stored);
            
            for (const confirmation of confirmations) {
                try {
                    await submitConfirmation(confirmation);
                } catch (error) {
                    console.error('Failed to sync offline confirmation:', error);
                }
            }

            // Clear synced confirmations
            localStorage.removeItem('cims_offline_confirmations');
            offlineConfirmations = [];
        }

        // Cancel confirmation
        function cancelConfirmation() {
            if (confirm('Are you sure you want to cancel? The task will remain incomplete.')) {
                window.location.href = '/mobile_dashboard';
            }
        }

        // Show/hide loading overlay
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.add('show');
            } else {
                overlay.classList.remove('show');
            }
        }

        // Helper function to format date/time
        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Handle online/offline events
        window.addEventListener('online', function() {
            checkOnlineStatus();
        });

        window.addEventListener('offline', function() {
            checkOnlineStatus();
        });
    </script>
</body>
</html>
