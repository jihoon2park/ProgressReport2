<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edenfield Dashboard - Executive Overview</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-dark: #1a1a2e;
            --primary-accent: #16213e;
            --secondary-accent: #0f3460;
            --highlight: #e94560;
            --success: #00d9a5;
            --warning: #ffc107;
            --info: #17a2b8;
            --light-bg: #f0f2f5;
            --card-shadow: 0 8px 30px rgba(0,0,0,0.08);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--light-bg) 0%, #e8ecef 100%);
            min-height: 100vh;
        }
        
        /* Header */
        .dashboard-header {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-accent) 50%, var(--secondary-accent) 100%);
            color: white;
            padding: 1.2rem 2rem;
            position: relative;
            overflow: hidden;
        }
        
        .dashboard-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="0.5"/></svg>');
            background-size: 50px 50px;
            opacity: 0.3;
        }
        
        .dashboard-header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            letter-spacing: -1px;
            position: relative;
            z-index: 1;
        }
        
        .dashboard-header .subtitle {
            font-size: 0.95rem;
            opacity: 0.8;
            position: relative;
            z-index: 1;
        }
        
        .nav-links {
            position: relative;
            z-index: 1;
        }
        
        .nav-links a {
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            margin-left: 1.5rem;
            transition: color 0.3s;
            font-size: 0.85rem;
        }
        
        .nav-links a:hover {
            color: var(--highlight);
        }
        
        /* Main Content */
        .main-content {
            padding: 1.5rem;
            max-width: 1600px;
            margin: 0 auto;
        }
        
        /* KPI Card */
        .kpi-card {
            background: white;
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            padding: 1.5rem;
            height: 100%;
        }
        
        .kpi-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .kpi-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            color: white;
            margin-right: 1rem;
            flex-shrink: 0;
        }
        
        .kpi-icon.primary { background: linear-gradient(135deg, var(--secondary-accent), var(--primary-dark)); }
        .kpi-icon.warning { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .kpi-icon.danger { background: linear-gradient(135deg, var(--highlight), #c0392b); }
        .kpi-icon.info { background: linear-gradient(135deg, var(--info), #2980b9); }
        .kpi-icon.success { background: linear-gradient(135deg, var(--success), #27ae60); }
        
        .kpi-info {
            flex: 1;
        }
        
        .kpi-number {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary-dark);
            line-height: 1;
        }
        
        .kpi-label {
            font-size: 0.85rem;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 0.25rem;
        }
        
        /* Chart Container */
        .chart-wrapper {
            height: 180px;
            position: relative;
        }
        
        /* Incident Status Grid */
        .status-section {
            background: white;
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            padding: 1.5rem;
        }
        
        .status-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary-dark);
            margin-bottom: 1rem;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }
        
        .status-item {
            text-align: center;
            padding: 1rem 0.5rem;
            border-radius: 12px;
            background: #f8f9fa;
            transition: transform 0.2s;
        }
        
        .status-item:hover {
            transform: translateY(-2px);
        }
        
        .status-item.open { border-top: 3px solid var(--warning); }
        .status-item.closed { border-top: 3px solid var(--success); }
        .status-item.hospital { border-top: 3px solid var(--highlight); }
        .status-item.ambulance { border-top: 3px solid var(--info); }
        
        .status-number {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-dark);
        }
        
        .status-label {
            font-size: 0.75rem;
            color: #6c757d;
            text-transform: uppercase;
            margin-top: 0.25rem;
        }
        
        /* Period Filter */
        .period-filter {
            background: white;
            border-radius: 16px;
            padding: 1rem 1.5rem;
            box-shadow: var(--card-shadow);
        }
        
        .btn-period {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            color: #6c757d;
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .btn-period:hover {
            background: #e9ecef;
            color: var(--primary-dark);
        }
        
        .btn-period.active {
            background: var(--secondary-accent);
            border-color: var(--secondary-accent);
            color: white;
        }
        
        /* Site Cards */
        .site-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--card-shadow);
            height: 100%;
            transition: transform 0.2s;
        }
        
        .site-card:hover {
            transform: translateY(-3px);
        }
        
        .site-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .site-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-dark);
        }
        
        .site-badge {
            padding: 0.4rem 0.8rem;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 0.6rem 0;
            border-bottom: 1px solid #f5f5f5;
        }
        
        .stat-row:last-child {
            border-bottom: none;
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 0.85rem;
        }
        
        .stat-value {
            font-weight: 600;
            color: var(--primary-dark);
            font-size: 0.95rem;
        }
        
        .stat-value.danger { color: var(--highlight); }
        .stat-value.success { color: var(--success); }
        .stat-value.warning { color: var(--warning); }
        .stat-value.info { color: var(--info); }
        
        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--light-bg);
            border-top-color: var(--secondary-accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 992px) {
            .status-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 576px) {
            .kpi-number {
                font-size: 1.8rem;
            }
            .chart-wrapper {
                height: 150px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="text-center">
            <div class="loading-spinner"></div>
            <p class="mt-3 text-muted">Loading Edenfield Data...</p>
        </div>
    </div>

    <!-- Header -->
    <div class="dashboard-header">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center flex-wrap">
                <div>
                    <h1><i class="fas fa-building me-2"></i>Edenfield Dashboard</h1>
                    <p class="subtitle mb-0">Executive Overview - All 5 Sites</p>
                </div>
                <div class="nav-links">
                    <a href="/progress-notes"><i class="fas fa-notes-medical me-1"></i> Progress Notes</a>
                    <a href="/integrated_dashboard"><i class="fas fa-chart-line me-1"></i> CIMS</a>
                    <a href="/"><i class="fas fa-home me-1"></i> Home</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Period Filter -->
        <div class="period-filter mb-4">
            <div class="d-flex align-items-center justify-content-between flex-wrap">
                <h5 class="mb-0" style="color: var(--primary-dark);"><i class="fas fa-filter me-2"></i>Period Filter</h5>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-period" data-period="today" onclick="changePeriod('today')">
                        <i class="fas fa-calendar-day me-1"></i>Today
                    </button>
                    <button type="button" class="btn btn-period" data-period="week" onclick="changePeriod('week')">
                        <i class="fas fa-calendar-week me-1"></i>This Week
                    </button>
                    <button type="button" class="btn btn-period active" data-period="month" onclick="changePeriod('month')">
                        <i class="fas fa-calendar-alt me-1"></i>This Month
                    </button>
                </div>
            </div>
        </div>

        <!-- Edenfield Total Card (Period Filter Î∞îÎ°ú ÏïÑÎûò) - Incident Status Ìè¨Ìï® -->
        <div id="edenfieldTotalCard" class="mb-4">
            <div class="site-card" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: white;">
                <div class="site-card-header" style="border-bottom-color: rgba(255,255,255,0.2);">
                    <div class="site-name" style="color: white; font-size: 1.4rem;">
                        <i class="fas fa-building me-2" style="color: #00d9a5;"></i>
                        Edenfield Total
                    </div>
                    <span id="totalResidentsBadge" class="site-badge" style="background: rgba(0,217,165,0.2); color: #00d9a5; font-size: 1rem;">
                        -- Residents (5 Sites)
                    </span>
                </div>
                <!-- Ìïú Ï§Ñ: Incidents, Open, Closed, Hospital, Ambulance, Notes -->
                <div class="row">
                    <div class="col-md-2 col-4 text-center py-3">
                        <div id="totalIncidentsValue" style="font-size: 1.8rem; font-weight: 700;">--</div>
                        <div id="totalIncidentsLabel" style="font-size: 0.8rem; opacity: 0.8;">üìä Incidents</div>
                    </div>
                    <div class="col-md-2 col-4 text-center py-3">
                        <div id="totalOpenValue" style="font-size: 1.8rem; font-weight: 700; color: #ffc107;">--</div>
                        <div style="font-size: 0.8rem; opacity: 0.8;">üü° Open</div>
                    </div>
                    <div class="col-md-2 col-4 text-center py-3">
                        <div id="totalClosedValue" style="font-size: 1.8rem; font-weight: 700; color: #00d9a5;">--</div>
                        <div style="font-size: 0.8rem; opacity: 0.8;">‚úÖ Closed</div>
                    </div>
                    <div class="col-md-2 col-4 text-center py-3">
                        <div id="totalHospitalValue" style="font-size: 1.8rem; font-weight: 700; color: #9b59b6;">--</div>
                        <div style="font-size: 0.8rem; opacity: 0.8;">üè• Hospital</div>
                    </div>
                    <div class="col-md-2 col-4 text-center py-3">
                        <div id="totalAmbulanceValue" style="font-size: 1.8rem; font-weight: 700; color: #3498db;">--</div>
                        <div style="font-size: 0.8rem; opacity: 0.8;">üöë Ambulance</div>
                    </div>
                    <div class="col-md-2 col-4 text-center py-3">
                        <div id="totalNotesValue" style="font-size: 1.8rem; font-weight: 700; color: #17a2b8;">--</div>
                        <div style="font-size: 0.8rem; opacity: 0.8;">üìù Notes</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 1: Residents & Incidents -->
        <div class="row g-4 mb-4">
            <div class="col-lg-6">
                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-icon primary">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="kpi-info">
                            <div class="kpi-number" id="totalResidents">--</div>
                            <div class="kpi-label">Total Residents</div>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="residentsChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-icon warning">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="kpi-info">
                            <div class="kpi-number" id="incidents30Days">--</div>
                            <div class="kpi-label" id="incidentsLabel">Incidents (30 Days)</div>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="incidentsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 2: Progress Notes & Activities -->
        <div class="row g-4 mb-4">
            <div class="col-lg-6">
                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-icon success">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                        <div class="kpi-info">
                            <div class="kpi-number" id="progressNotes30Days">--</div>
                            <div class="kpi-label" id="progressNotesLabel">Progress Notes (30D)</div>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="progressNotesChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-icon info">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <div class="kpi-info">
                            <div class="kpi-number" id="activities30Days">--</div>
                            <div class="kpi-label" id="activitiesLabel">Activities (30 Days)</div>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="activitiesChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 3: Activity Types Breakdown -->
        <div class="row g-4 mb-4">
            <div class="col-12">
                <div class="kpi-card">
                    <div class="kpi-header" style="border-bottom: none; padding-bottom: 0;">
                        <div class="kpi-icon" style="background: linear-gradient(135deg, #9b59b6, #8e44ad);">
                            <i class="fas fa-list-ul"></i>
                        </div>
                        <div class="kpi-info">
                            <div class="kpi-label" id="activityTypesLabel" style="margin-top: 0;">Activity Types Breakdown</div>
                        </div>
                    </div>
                    <div style="height: 200px; padding: 1rem 0;">
                        <canvas id="activityTypesChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 4: Falls & Skin/Wound -->
        <div class="row g-4 mb-4">
            <div class="col-lg-6">
                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-icon danger">
                            <i class="fas fa-person-falling"></i>
                        </div>
                        <div class="kpi-info">
                            <div class="kpi-number" id="totalFalls">--</div>
                            <div class="kpi-label" id="fallsLabel">Total Falls</div>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="fallsChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-icon" style="background: linear-gradient(135deg, #e67e22, #d35400);">
                            <i class="fas fa-band-aid"></i>
                        </div>
                        <div class="kpi-info">
                            <div class="kpi-number" id="totalSkinWound">--</div>
                            <div class="kpi-label" id="skinWoundLabel">Skin & Wound</div>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="skinWoundChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Site Statistics Section -->
        <h4 class="mb-3" style="color: var(--primary-dark); font-weight: 600;">
            <i class="fas fa-hospital me-2"></i>Site-by-Site Statistics
        </h4>
        <div class="row g-4" id="siteCardsContainer">
            <!-- Site cards will be dynamically generated -->
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let chartInstances = {};
        let currentPeriod = 'month';
        const siteColors = ['#e94560', '#0f3460', '#00d9a5', '#ffc107', '#17a2b8'];
        
        document.addEventListener('DOMContentLoaded', function() {
            loadEdenfieldStats();
        });
        
        function changePeriod(period) {
            currentPeriod = period;
            
            // Update button states
            document.querySelectorAll('.btn-period').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.period === period) {
                    btn.classList.add('active');
                }
            });
            
            // Reload data
            loadEdenfieldStats();
        }
        
        async function loadEdenfieldStats() {
            try {
                const response = await fetch(`/api/edenfield/stats?period=${currentPeriod}`, {
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load stats');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    updateTotals(data.totals);
                    createAllCharts(data.sites);
                    createSiteCards(data.sites, data.totals);
                }
                
                document.getElementById('loadingOverlay').style.display = 'none';
                
            } catch (error) {
                console.error('Error loading Edenfield stats:', error);
                document.getElementById('loadingOverlay').innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-exclamation-circle text-danger" style="font-size: 3rem;"></i>
                        <p class="mt-3 text-danger">Failed to load data. Please try again.</p>
                        <button class="btn btn-primary" onclick="location.reload()">Retry</button>
                    </div>
                `;
            }
        }
        
        function updateTotals(totals) {
            document.getElementById('totalResidents').textContent = totals.total_persons.toLocaleString();
            document.getElementById('incidents30Days').textContent = totals.incidents_30days.toLocaleString();
            document.getElementById('totalFalls').textContent = totals.fall_count.toLocaleString();
            document.getElementById('progressNotes30Days').textContent = totals.progress_notes_30days.toLocaleString();
            document.getElementById('activities30Days').textContent = totals.activities_30days.toLocaleString();
            
            // Incident status (Edenfield Total CardÏóê ÌÜµÌï©Îê®)
            document.getElementById('totalHospitalValue').textContent = totals.hospital_admissions.toLocaleString();
            document.getElementById('totalAmbulanceValue').textContent = totals.ambulance_calls.toLocaleString();
            
            // Update labels based on period
            const periodLabels = {
                'today': 'Today',
                'week': '7 Days',
                'month': '30 Days'
            };
            const periodLabel = periodLabels[currentPeriod] || '30 Days';
            
            document.getElementById('incidentsLabel').textContent = `Incidents (${periodLabel})`;
            document.getElementById('progressNotesLabel').textContent = `Progress Notes (${periodLabel})`;
            document.getElementById('activitiesLabel').textContent = `Activities (${periodLabel})`;
            document.getElementById('fallsLabel').textContent = `Falls (${periodLabel})`;
            document.getElementById('skinWoundLabel').textContent = `Skin & Wound (${periodLabel})`;
            document.getElementById('activityTypesLabel').textContent = `Activity Types Breakdown (${periodLabel})`;
            
            // Skin & Wound Ï¥ùÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('totalSkinWound').textContent = totals.skin_wound_count.toLocaleString();
            
            // Activity Types Ï∞®Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏ (Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏñ¥ÎèÑ ÏóÖÎç∞Ïù¥Ìä∏)
            if (totals.activity_types) {
                createActivityTypesChart(totals.activity_types);
            } else {
                // Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏùÑ Îïå Í∏∞Ï°¥ Ï∞®Ìä∏ Ï†úÍ±∞ÌïòÍ≥† Îπà Ï∞®Ìä∏ ÌëúÏãú
                if (chartInstances['activityTypes']) {
                    chartInstances['activityTypes'].destroy();
                    delete chartInstances['activityTypes'];
                }
                // Îπà Ï∞®Ìä∏ ÏÉùÏÑ±
                createActivityTypesChart([]);
            }
        }
        
        function createActivityTypesChart(activityTypes) {
            const ctx = document.getElementById('activityTypesChart');
            
            if (chartInstances['activityTypes']) {
                chartInstances['activityTypes'].destroy();
            }
            
            // Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏùÑ Îïå Îπà Î∞∞Ïó¥ Ï≤òÎ¶¨
            const labels = activityTypes && activityTypes.length > 0 
                ? activityTypes.map(a => a.name) 
                : ['No data'];
            const data = activityTypes && activityTypes.length > 0 
                ? activityTypes.map(a => a.count) 
                : [0];
            const colors = [
                '#e94560', '#0f3460', '#00d9a5', '#ffc107', '#17a2b8',
                '#9b59b6', '#3498db', '#e74c3c', '#2ecc71', '#f39c12'
            ];
            
            chartInstances['activityTypes'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Activities',
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderRadius: 6,
                        barThickness: 25
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return ' ' + context.raw.toLocaleString() + ' sessions';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0,0,0,0.05)' },
                            ticks: { font: { size: 11 } }
                        },
                        y: {
                            grid: { display: false },
                            ticks: { 
                                font: { size: 11, weight: '500' },
                                color: '#1a1a2e'
                            }
                        }
                    }
                }
            });
        }
        
        function createAllCharts(sites) {
            const siteNames = sites.map(s => s.site);
            
            // 1. Residents Chart
            createBarChart('residentsChart', siteNames, 
                sites.map(s => s.total_persons), 'Residents');
            
            // 2. Incidents Chart
            createBarChart('incidentsChart', siteNames, 
                sites.map(s => s.incidents_30days), 'Incidents');
            
            // 3. Falls Chart
            createBarChart('fallsChart', siteNames, 
                sites.map(s => s.fall_count), 'Falls');
            
            // 4. Skin & Wound Chart
            createBarChart('skinWoundChart', siteNames, 
                sites.map(s => s.skin_wound_count || 0), 'Skin/Wound');
            
            // 5. Progress Notes Chart
            createBarChart('progressNotesChart', siteNames, 
                sites.map(s => s.progress_notes_30days), 'Notes');
            
            // 6. Activities Chart
            createBarChart('activitiesChart', siteNames, 
                sites.map(s => s.activities_30days), 'Activities');
        }
        
        function createSiteCards(sites, totals) {
            const container = document.getElementById('siteCardsContainer');
            container.innerHTML = '';
            
            const colors = ['#e94560', '#0f3460', '#00d9a5', '#ffc107', '#17a2b8'];
            
            // Period label for cards
            const periodLabels = {
                'today': 'Today',
                'week': '7D',
                'month': '30D'
            };
            const pLabel = periodLabels[currentPeriod] || '30D';
            
            // Edenfield Total Card ÏóÖÎç∞Ïù¥Ìä∏ (ÏÉÅÎã® Î≥ÑÎèÑ ÏÑπÏÖò)
            document.getElementById('totalResidentsBadge').textContent = `${totals.total_persons.toLocaleString()} Residents (5 Sites)`;
            document.getElementById('totalIncidentsValue').textContent = totals.incidents_30days.toLocaleString();
            document.getElementById('totalIncidentsLabel').textContent = `Incidents (${pLabel})`;
            document.getElementById('totalOpenValue').textContent = totals.open_incidents.toLocaleString();
            document.getElementById('totalClosedValue').textContent = totals.closed_incidents.toLocaleString();
            document.getElementById('totalNotesValue').textContent = totals.progress_notes_30days.toLocaleString();
            
            // Site Cards Container Ï¥àÍ∏∞Ìôî
            container.innerHTML = '';
            
            sites.forEach((site, index) => {
                const cardHtml = `
                    <div class="col-lg-4 col-md-6">
                        <div class="site-card">
                            <div class="site-card-header">
                                <div class="site-name">
                                    <i class="fas fa-hospital-alt me-2" style="color: ${colors[index]}"></i>
                                    ${site.site}
                                </div>
                                <span class="site-badge" style="background: ${colors[index]}20; color: ${colors[index]}">
                                    ${site.total_persons.toLocaleString()} Residents
                                </span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label"><i class="fas fa-exclamation-circle me-2"></i>Incidents (${pLabel})</span>
                                <span class="stat-value">${site.incidents_30days.toLocaleString()}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label"><i class="fas fa-clock me-2"></i>Open</span>
                                <span class="stat-value warning">${site.incidents.open.toLocaleString()}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label"><i class="fas fa-check-circle me-2"></i>Closed</span>
                                <span class="stat-value success">${site.incidents.closed.toLocaleString()}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label"><i class="fas fa-person-falling me-2"></i>Falls (${pLabel})</span>
                                <span class="stat-value danger">${site.fall_count.toLocaleString()}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label"><i class="fas fa-band-aid me-2"></i>Skin & Wound (${pLabel})</span>
                                <span class="stat-value" style="color: #e67e22;">${(site.skin_wound_count || 0).toLocaleString()}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label"><i class="fas fa-notes-medical me-2"></i>Progress Notes (${pLabel})</span>
                                <span class="stat-value info">${site.progress_notes_30days.toLocaleString()}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label"><i class="fas fa-calendar-check me-2"></i>Activities (${pLabel})</span>
                                <span class="stat-value">${site.activities_30days.toLocaleString()}</span>
                            </div>
                            ${site.error ? `<div class="alert alert-warning mt-2 mb-0 py-2"><small><i class="fas fa-exclamation-triangle me-1"></i>${site.error}</small></div>` : ''}
                        </div>
                    </div>
                `;
                container.innerHTML += cardHtml;
            });
        }
        
        function createBarChart(canvasId, labels, data, label) {
            const ctx = document.getElementById(canvasId);
            
            if (chartInstances[canvasId]) {
                chartInstances[canvasId].destroy();
            }
            
            chartInstances[canvasId] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        backgroundColor: siteColors,
                        borderRadius: 6,
                        barThickness: 28,
                        maxBarThickness: 35
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            right: 20
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            padding: 12,
                            titleFont: { size: 13 },
                            bodyFont: { size: 12 },
                            callbacks: {
                                label: function(context) {
                                    return ' ' + context.raw.toLocaleString() + ' ' + label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: { 
                                color: 'rgba(0,0,0,0.05)',
                                drawBorder: false
                            },
                            ticks: { 
                                font: { size: 11 },
                                color: '#6c757d'
                            }
                        },
                        y: {
                            grid: { display: false },
                            ticks: { 
                                font: { 
                                    size: 12, 
                                    weight: '600'
                                },
                                color: '#1a1a2e',
                                padding: 8
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
