<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Nurse Visit Schedule</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #17a2b8;
        }

        * {
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            font-size: 16px;
            font-weight: 500;
            overflow-x: hidden;
        }
        
        /* Fixed layout container */
        .page-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* Header */
        .mobile-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            position: relative;
            z-index: 1000;
            flex-shrink: 0;  /* Í≥†Ï†ï ÌÅ¨Í∏∞ Ïú†ÏßÄ */
        }

        .header-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
            margin: 0;
        }

        .header-subtitle {
            color: #666;
            font-size: 1.1rem;
            font-weight: 600;
            margin-top: 0.3rem;
        }

        .last-update {
            color: #999;
            font-size: 0.8rem;
            margin-top: 0.3rem;
        }
        
        .last-update-inline {
            font-size: 0.65rem;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 0.3rem;
            text-align: center;
            font-weight: 500;
        }
        
        /* Current Time Display */
        .current-time-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 0.8rem 2rem 0.5rem 2rem;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            animation: pulse-glow 2s infinite;
            text-align: center;
        }

        .current-time-value {
            font-size: 3rem;
            font-weight: 900;
            color: white;
            font-family: 'Courier New', monospace;
            letter-spacing: 3px;
            text-shadow: 0 3px 8px rgba(0, 0, 0, 0.4);
            animation: blink-time 1.5s infinite;
        }
        
        @keyframes pulse-glow {
            0%, 100% {
                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            }
            50% {
                box-shadow: 0 6px 25px rgba(102, 126, 234, 0.7);
            }
        }
        
        @keyframes blink-time {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.85;
                transform: scale(1.05);
            }
        }

        /* Filter Bar */
        .filter-bar {
            background: white;
            margin: 1rem;
            padding: 1rem;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-shrink: 0;  /* Í≥†Ï†ï ÌÅ¨Í∏∞ Ïú†ÏßÄ */
        }

        .filter-group {
            flex: 1;
        }

        .filter-group label {
            font-weight: bold;
            font-size: 0.9rem;
            color: var(--primary-color);
            margin-bottom: 0.3rem;
            display: block;
        }

        .filter-select {
            width: 100%;
            padding: 0.6rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            cursor: pointer;
        }

        .filter-select:focus {
            border-color: var(--secondary-color);
            outline: none;
        }
        
        /* Clear Cache Button */
        .btn-clear-cache {
            background: linear-gradient(135deg, var(--warning-color), #e67e22);
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(243, 156, 18, 0.3);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
        }

        .btn-clear-cache:hover {
            background: linear-gradient(135deg, #e67e22, var(--warning-color));
            box-shadow: 0 4px 12px rgba(243, 156, 18, 0.5);
            transform: translateY(-2px);
        }
        
        .btn-clear-cache:active {
            transform: translateY(0);
        }

        /* Timetable */
        .timetable-container {
            background: white;
            margin: 1rem;
            padding: 0;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden;
            flex: 1;  /* ÎÇ®ÏùÄ Í≥µÍ∞Ñ Î™®Îëê ÏÇ¨Ïö© */
            display: flex;
            flex-direction: column;
        }

        .timetable-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;  /* Í≥†Ï†ï ÌÅ¨Í∏∞ Ïú†ÏßÄ */
        }

        .timetable-header h6 {
            margin: 0;
            font-weight: bold;
        }

        .visit-count {
            background: rgba(255,255,255,0.3);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .schedule-table-wrapper {
            overflow-x: auto;
            overflow-y: auto;
            flex: 1;  /* ÎÇ®ÏùÄ Í≥µÍ∞Ñ Î™®Îëê ÏÇ¨Ïö©ÌïòÍ≥† Ïä§ÌÅ¨Î°§ */
            -webkit-overflow-scrolling: touch;  /* iOS Î∂ÄÎìúÎü¨Ïö¥ Ïä§ÌÅ¨Î°§ */
        }

        .schedule-table {
            width: 100%;
            border-collapse: collapse;
        }

        .schedule-table thead th {
            background: #f8f9fa;
            color: var(--primary-color);
            font-weight: bold;
            padding: 0.8rem 0.5rem;
            text-align: left;
            border-bottom: 2px solid #dee2e6;
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 0.85rem;
        }

        .schedule-table tbody td {
            padding: 1rem 0.6rem;
            border-bottom: 1px solid #e9ecef;
            font-size: 1.1rem;
            font-weight: 600;
            vertical-align: top;
        }

        .schedule-table tbody tr:hover {
            background: #f0f0f0;
            cursor: pointer;
        }

        .schedule-table tbody tr.overdue {
            background: #fff5f5;
        }

        /* Incident color coding */
        .incident-color-1 { background: #e3f2fd !important; }
        .incident-color-2 { background: #f3e5f5 !important; }
        .incident-color-3 { background: #e8f5e9 !important; }
        .incident-color-4 { background: #fff3e0 !important; }
        .incident-color-5 { background: #fce4ec !important; }
        .incident-color-6 { background: #e0f2f1 !important; }
        
        .incident-color-1.overdue { background: #ffcdd2 !important; }
        .incident-color-2.overdue { background: #ffcdd2 !important; }
        .incident-color-3.overdue { background: #ffcdd2 !important; }
        .incident-color-4.overdue { background: #ffcdd2 !important; }
        .incident-color-5.overdue { background: #ffcdd2 !important; }
        .incident-color-6.overdue { background: #ffcdd2 !important; }

        /* Current time task - blink animation (Îπ®Í∞ÑÏÉâ Í≥ÑÏó¥) */
        .current-task {
            animation: blink-current 1.2s infinite;
            border: 3px solid #dc3545 !important;
            position: relative;
        }
        
        /* Next task indicator */
        .current-task::before {
            content: '‚ñ∂ NEXT';
            position: absolute;
            left: -5px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 900;
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.5);
            animation: pulse-next 1.5s infinite;
        }
        
        @keyframes pulse-next {
            0%, 100% {
                opacity: 1;
                transform: translateY(-50%) scale(1);
            }
            50% {
                opacity: 0.8;
                transform: translateY(-50%) scale(1.1);
            }
        }

        @keyframes blink-current {
            0%, 100% { 
                background: #ffebee !important;
                box-shadow: 0 0 15px rgba(220, 53, 69, 0.6);
                opacity: 1;
            }
            50% { 
                background: #ffcdd2 !important;
                box-shadow: 0 0 25px rgba(220, 53, 69, 0.9);
                opacity: 0.95;
            }
        }
        
        .current-task td {
            font-weight: 600 !important;
            color: #c62828 !important;
        }

        .time-cell {
            font-weight: 700;
            color: var(--info-color);
            white-space: nowrap;
            font-size: 1.2rem;
        }

        .patient-cell {
            font-weight: 700;
            font-size: 1.15rem;
            color: var(--primary-color);
        }

        .location-cell {
            color: #666;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .type-cell {
            font-size: 1.1rem;
            color: #333;
            font-weight: 700;
        }

        .occurred-cell {
            font-size: 1rem;
            font-weight: 600;
            color: #666;
        }

        .incident-cell {
            font-size: 1rem;
            font-weight: 600;
            color: #333;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .incident-cell:hover {
            background: rgba(0, 0, 0, 0.05);
            transform: scale(1.05);
        }

        .incident-id {
            font-weight: 900;
            font-size: 1.4rem;
            color: var(--primary-color);
            display: block;
        }

        .incident-description {
            color: #666;
            font-size: 0.95rem;
            font-weight: 500;
            margin-top: 0.3rem;
            line-height: 1.3;
        }

        .tasks-cell {
            font-size: 0.75rem;
            font-weight: 500;
            color: #555;
            line-height: 1.3;
        }

        .status-cell {
            text-align: center;
        }

        .status-badge {
            display: inline-block;
            padding: 0.5rem 0.8rem;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            white-space: nowrap;
        }

        .status-ok {
            background: #d4edda;
            color: #155724;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-overdue {
            background: #f8d7da;
            color: #721c24;
        }

        .phase-badge {
            background: #e3f2fd;
            color: #1976d2;
            padding: 0.4rem 0.7rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 700;
            margin-left: 0.3rem;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #999;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Loading */
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .loading-spinner.active {
            display: block;
        }

        /* Auto Refresh Indicator */
        .auto-refresh-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            display: none;
        }

        .auto-refresh-indicator.active {
            display: block;
        }
        
        /* Scroll to Next Task Button */
        .btn-scroll-next {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.5);
            transition: all 0.3s ease;
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-scroll-next:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.7);
        }
        
        .btn-scroll-next:active {
            transform: scale(0.95);
        }
        
        .btn-scroll-next i {
            animation: bounce-down 1.5s infinite;
        }
        
        @keyframes bounce-down {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(5px);
            }
        }

        /* Modal popup */
        .incident-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .incident-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 20px;
            padding: 2rem;
            max-width: 90%;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from { 
                transform: translate(-50%, -60%);
                opacity: 0;
            }
            to { 
                transform: translate(-50%, -50%);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e9ecef;
        }

        .modal-title {
            font-size: 1.8rem;
            font-weight: 900;
            color: var(--primary-color);
        }

        .modal-close {
            background: #dc3545;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #c82333;
            transform: rotate(90deg);
        }

        .modal-body {
            font-size: 1.1rem;
            line-height: 1.6;
        }

        .modal-section {
            margin-bottom: 1.5rem;
        }

        .modal-section-title {
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
            font-size: 1.2rem;
        }

        .modal-section-content {
            color: #333;
            padding: 0.8rem;
            background: #f8f9fa;
            border-radius: 10px;
            font-size: 1rem;
        }

        .auto-close-timer {
            text-align: center;
            margin-top: 1rem;
            font-size: 0.9rem;
            color: #666;
            font-style: italic;
        }
        
        /* ÌÉúÎ∏îÎ¶ø Î∞òÏùëÌòï (768px Ïù¥ÏÉÅ) */
        @media (min-width: 768px) {
            .header-title {
                font-size: 2.2rem;
            }
            
            .current-time-value {
                font-size: 3.5rem;
            }
            
            .filter-bar {
                max-width: 1200px;
                margin: 1.5rem auto;
            }
            
            .timetable-container {
                max-width: 1200px;
                margin: 1.5rem auto;
            }
            
            .schedule-table thead th {
                font-size: 1rem;
                padding: 1rem;
            }
            
            .schedule-table tbody td {
                font-size: 1.15rem;
                padding: 1.2rem 0.8rem;
            }
            
            .btn-scroll-next {
                right: 40px;
                bottom: 100px;
                width: 70px;
                height: 70px;
                font-size: 1.8rem;
            }
        }
        
        /* ÎåÄÌòï ÌÉúÎ∏îÎ¶ø & Îç∞Ïä§ÌÅ¨ÌÉë (1024px Ïù¥ÏÉÅ) */
        @media (min-width: 1024px) {
            .header-title {
                font-size: 2.5rem;
            }
            
            .current-time-value {
                font-size: 4rem;
            }
            
            .filter-bar {
                max-width: 1400px;
            }
            
            .timetable-container {
                max-width: 1400px;
            }
            
            .schedule-table thead th {
                font-size: 1.1rem;
            }
            
            .schedule-table tbody td {
                font-size: 1.2rem;
                padding: 1.5rem 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="page-container">
    <!-- Header -->
    <div class="mobile-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h5 class="header-title">
                    <i class="fas fa-user-nurse me-2"></i>Nurse Visit Schedule
                </h5>
            </div>
            <div class="current-time-display">
                <div class="current-time-value" id="currentTimeDisplay">--:--:--</div>
                <div class="last-update-inline" id="lastUpdate">Updated: --</div>
            </div>
            <button class="btn-back-dashboard" onclick="window.location.href='/integrated_dashboard'">
                    <i class="fas fa-home"></i>
                </button>
            </div>
        </div>
        
    <!-- Filter Bar -->
    <div class="filter-bar">
        <div class="filter-group">
            <label><i class="fas fa-hospital me-1"></i>Site</label>
            <select class="filter-select" id="siteSelect" onchange="loadSchedule()">
                <option value="">Select Site...</option>
                <option value="Parafield Gardens">Parafield Gardens</option>
                <option value="Nerrilda">Nerrilda</option>
                <option value="Ramsay">Ramsay</option>
                <option value="West Park">West Park</option>
                <option value="Yankalilla">Yankalilla</option>
            </select>
        </div>
        <div class="filter-group">
            <label><i class="fas fa-calendar-day me-1"></i>Date</label>
            <select class="filter-select" id="dateSelect" onchange="loadSchedule()">
                <!-- Dynamically generated -->
            </select>
    </div>
        <div class="filter-group" style="flex: 0; min-width: auto;">
            <label>&nbsp;</label>
            <button class="btn-clear-cache" onclick="clearCacheAndReload()" title="Clear cache and reload fresh data">
                <i class="fas fa-sync-alt"></i> Clear Cache
            </button>
        </div>
    </div>

    <!-- Timetable -->
    <div class="timetable-container">
        <div class="timetable-header">
            <h6 style="font-size: 1.3rem; font-weight: 700;"><i class="fas fa-clock me-2"></i>Visit Schedule</h6>
            <span class="visit-count" id="visitCount">0 visits</span>
    </div>

        <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
    </div>
            <p class="mt-2">Loading schedule...</p>
        </div>
        
        <div class="schedule-table-wrapper">
            <table class="schedule-table" id="scheduleTable">
                <thead>
                    <tr>
                        <th style="width: 90px;">Time</th>
                        <th style="width: 150px;">Patient</th>
                        <th style="width: 90px;">Room</th>
                        <th style="width: 110px;">Type</th>
                        <th style="width: 130px;">Occurred</th>
                        <th style="width: 80px; text-align: center;">INC #</th>
                        <th style="width: 220px;">Tasks</th>
                        <th style="width: 70px;">Phase</th>
                        <th style="width: 90px;">Status</th>
                    </tr>
                </thead>
                <tbody id="scheduleTableBody">
                    <tr>
                        <td colspan="9" class="text-center" style="padding: 3rem;">
                            <i class="fas fa-calendar-alt" style="font-size: 3rem; color: #ccc; display: block; margin-bottom: 1rem;"></i>
                            <p style="color: #999; font-size: 1.2rem; font-weight: 600;">Select site and date</p>
                            <small style="color: #ccc;">Select a site and date to view visit schedule</small>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    </div> <!-- Close page-container -->

    <!-- Auto Refresh Indicator -->
    <div class="auto-refresh-indicator" id="autoRefreshIndicator">
        <i class="fas fa-sync-alt fa-spin me-2"></i>Updating...
    </div>
    
    <!-- Scroll to Next Task Button -->
    <button class="btn-scroll-next" onclick="scrollToNextTask()" title="Jump to next task">
        <i class="fas fa-arrow-down"></i>
    </button>

    <script>
        let selectedSite = null;
        let selectedDate = null;
        let autoRefreshInterval = null;
        
        // üöÄ Phase 3: Local Storage Ï∫êÏã±
        const CACHE_TTL = 5 * 60 * 1000;  // 5Î∂Ñ
        const CACHE_PREFIX = 'visit_schedule_';

        // Initialize date dropdown (2 days later to 4 days ago)
        function initializeDateDropdown() {
            const dateSelect = document.getElementById('dateSelect');
            const today = new Date();
            
            // Future dates (2 days later, tomorrow)
            for (let i = 2; i >= 1; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                
                const dateStr = date.toISOString().split('T')[0];
                const dayLabel = i === 1 ? 'Tomorrow' : i === 2 ? 'Day after tomorrow' : `${i} days later`;
                const displayDate = date.toLocaleDateString('en-AU', {
                    month: 'short',
                    day: 'numeric',
                    weekday: 'short'
                });
                
                const option = document.createElement('option');
                option.value = dateStr;
                option.textContent = `${dayLabel} (${displayDate})`;
                
                dateSelect.appendChild(option);
            }
            
            // Today and past dates
            for (let i = 0; i < 5; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                
                const dateStr = date.toISOString().split('T')[0];
                const dayLabel = i === 0 ? 'Today' : i === 1 ? 'Yesterday' : `${i} days ago`;
                const displayDate = date.toLocaleDateString('en-AU', {
                    month: 'short',
                    day: 'numeric',
                    weekday: 'short'
                });
                
                const option = document.createElement('option');
                option.value = dateStr;
                option.textContent = `${dayLabel} (${displayDate})`;
                if (i === 0) option.selected = true;
                
                dateSelect.appendChild(option);
            }
            
            // Set today as default
            selectedDate = today.toISOString().split('T')[0];
        }

        // üöÄ Phase 3: Local Storage Ï∫êÏãú Ï°∞Ìöå
        function getCachedSchedule(site, date) {
            const cacheKey = `${CACHE_PREFIX}${site}_${date}`;
            const cached = localStorage.getItem(cacheKey);
            
            if (cached) {
                try {
                    const data = JSON.parse(cached);
                    const age = Date.now() - data.timestamp;
                    
                    if (age < CACHE_TTL) {
                        console.log(`‚úÖ [${site}] Cache HIT - Age: ${Math.round(age/1000)}s`);
                        return data.schedule;
                    } else {
                        console.log(`‚è∞ [${site}] Cache EXPIRED - Age: ${Math.round(age/1000)}s`);
                        localStorage.removeItem(cacheKey);
                    }
                } catch (e) {
                    console.error('Cache parse error:', e);
                    localStorage.removeItem(cacheKey);
                }
            }
            
            console.log(`üì¶ [${site}] Cache MISS`);
            return null;
        }
        
        // üöÄ Phase 3: Local Storage Ï∫êÏãú Ï†ÄÏû•
        function setCachedSchedule(site, date, schedule) {
            const cacheKey = `${CACHE_PREFIX}${site}_${date}`;
            try {
                const cacheData = {
                    schedule: schedule,
                    timestamp: Date.now(),
                    site: site,
                    date: date
                };
                localStorage.setItem(cacheKey, JSON.stringify(cacheData));
                console.log(`üíæ [${site}] Cache SAVED`);
            } catch (e) {
                console.error('Cache save error:', e);
                // LocalStorage Ïö©Îüâ Ï¥àÍ≥º Ïãú Ïò§ÎûòÎêú Ï∫êÏãú ÏÇ≠Ï†ú
                clearOldCache();
            }
        }
        
        // Ïò§ÎûòÎêú Ï∫êÏãú Ï†ïÎ¶¨
        function clearOldCache() {
            const keys = Object.keys(localStorage);
            const cacheKeys = keys.filter(k => k.startsWith(CACHE_PREFIX));
            
            // timestamp Í∏∞Ï§ÄÏúºÎ°ú Ï†ïÎ†¨ÌïòÏó¨ Ïò§ÎûòÎêú Í≤ÉÎ∂ÄÌÑ∞ ÏÇ≠Ï†ú
            cacheKeys.sort((a, b) => {
                const aData = JSON.parse(localStorage.getItem(a));
                const bData = JSON.parse(localStorage.getItem(b));
                return aData.timestamp - bData.timestamp;
            });
            
            // Í∞ÄÏû• Ïò§ÎûòÎêú Ï∫êÏãú 5Í∞ú ÏÇ≠Ï†ú
            for (let i = 0; i < Math.min(5, cacheKeys.length); i++) {
                localStorage.removeItem(cacheKeys[i]);
                console.log(`üóëÔ∏è  Removed old cache: ${cacheKeys[i]}`);
            }
        }
        
        // üßπ Î™®Îì† Ï∫êÏãú ÌÅ¥Î¶¨Ïñ¥ Î∞è ÏÉàÎ°úÍ≥†Ïπ®
        function clearCacheAndReload() {
            const keys = Object.keys(localStorage);
            const cacheKeys = keys.filter(k => k.startsWith(CACHE_PREFIX));
            
            console.log(`üßπ Clear Cache Î≤ÑÌäº ÌÅ¥Î¶≠ - ÌòÑÏû¨ Ï∫êÏãú: ${cacheKeys.length}Í∞ú`);
            
            // Î™®Îì† Î∞©Î¨∏ Ïä§ÏºÄÏ§Ñ Ï∫êÏãú ÏÇ≠Ï†ú
            cacheKeys.forEach(key => {
                localStorage.removeItem(key);
                console.log(`  üóëÔ∏è  Deleted: ${key}`);
            });
            
            console.log(`‚úÖ Cleared ${cacheKeys.length} cached schedules`);
            
            // Î≤ÑÌäº ÌîºÎìúÎ∞±
            const btn = event.target.closest('.btn-clear-cache');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check me-2"></i>Cleared!';
            btn.style.background = 'linear-gradient(135deg, #27ae60, #229954)';
            
            // ÎÇ†Ïßú ÎìúÎ°≠Îã§Ïö¥ÏùÑ Ïò§ÎäòÎ°ú Ïû¨ÏÑ§Ï†ï
            const dateSelect = document.getElementById('dateSelect');
            const today = new Date().toISOString().split('T')[0];
            
            // Ïò§Îäò ÎÇ†Ïßú ÏòµÏÖò Ï∞æÍ∏∞
            for (let i = 0; i < dateSelect.options.length; i++) {
                if (dateSelect.options[i].value === today) {
                    dateSelect.selectedIndex = i;
                    selectedDate = today;
                    console.log(`üìÖ ÎÇ†ÏßúÎ•º Ïò§ÎäòÎ°ú Ïû¨ÏÑ§Ï†ï: ${today}`);
                    break;
                }
            }
            
            // 1Ï¥à ÌõÑ Ïä§ÏºÄÏ§Ñ ÏÉàÎ°úÍ≥†Ïπ®
            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.style.background = '';
                loadSchedule();
            }, 1000);
        }

        // Load visit schedule
        async function loadSchedule() {
            // Get selected site from dropdown
            selectedSite = document.getElementById('siteSelect').value;
            selectedDate = document.getElementById('dateSelect').value;
            
            if (!selectedSite) {
                showEmpty('Select a site', 'Please select a site to continue');
                return;
            }

            if (!selectedDate) {
                showEmpty('Select a date', 'Please select a date to continue');
                return;
            }

            // üöÄ Phase 3: Ï∫êÏãú ÌôïÏù∏
            const cached = getCachedSchedule(selectedSite, selectedDate);
            if (cached) {
                try {
                    await renderScheduleFromCache(cached);
                    updateLastUpdateTime();
                    return;
                } catch (e) {
                    console.error('Cache render error:', e);
                    // Ï∫êÏãú Î†åÎçîÎßÅ Ïã§Ìå® Ïãú API Ìò∏Ï∂úÎ°ú fallback
                }
            }

            showLoading();

            try {
                // üöÄ Phase 2: Batch API Ìò∏Ï∂ú (Ìïú Î≤àÏóê Î™®Îì† Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå)
                console.log(`üöÄ [${selectedSite}] Batch API call...`);
                const response = await fetch(`/api/cims/schedule-batch/${encodeURIComponent(selectedSite)}/${selectedDate}`);
                
                if (!response.ok) {
                    throw new Error('Failed to load schedule');
                }
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Failed to load schedule');
                }
                
                // TasksÍ∞Ä ÏûêÎèô ÏÉùÏÑ±ÎêòÏóàÏúºÎ©¥ 5Ï¥à ÌõÑ Îã§Ïãú Î°úÎìú
                if (data.auto_generated) {
                    console.log('üí° TasksÍ∞Ä ÏûêÎèô ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§ - 5Ï¥à ÌõÑ Ïû¨Î°úÎìú...');
                    showEmpty('Initializing...', 'Setting up visit schedule for the first time. Please wait...');
                    setTimeout(() => {
                        loadSchedule();
                    }, 5000);
                    return;
                }
                
                // üöÄ Phase 3: Ï∫êÏãú Ï†ÄÏû•
                setCachedSchedule(selectedSite, selectedDate, data);
                
                // Ïä§ÏºÄÏ§Ñ Î†åÎçîÎßÅ
                await renderScheduleFromBatchAPI(data);

                // Update last update time
                updateLastUpdateTime();
                
            } catch (error) {
                console.error('Error loading schedule:', error);
                showEmpty('No visits scheduled', 'No visits scheduled for this date');
            }
        }

        // üöÄ Phase 3: Ï∫êÏãúÏóêÏÑú Ïä§ÏºÄÏ§Ñ Î†åÎçîÎßÅ
        async function renderScheduleFromCache(cachedData) {
            console.log(`‚ö° [${selectedSite}] Rendering from cache...`);
            
            if (!cachedData.incidents || cachedData.incidents.length === 0) {
                showEmpty('No visits scheduled', 'No visits scheduled for this date');
                return;
            }
            
            // Batch API ÌòïÏãùÍ≥º ÎèôÏùºÌïòÍ≤å Ï≤òÎ¶¨
            await renderScheduleFromBatchAPI(cachedData);
        }
        
        // üöÄ Phase 2: Batch API ÏùëÎãµÏúºÎ°ú Ïä§ÏºÄÏ§Ñ Î†åÎçîÎßÅ
        async function renderScheduleFromBatchAPI(data) {
            const tableBody = document.getElementById('scheduleTableBody');
            const visitCount = document.getElementById('visitCount');
            
            const incidents = data.incidents || [];
            const policies = data.policies || {};  // All policies by policy_id
            const policy = data.policy;  // Fallback for backwards compatibility
            
            console.log(`üîç [${selectedSite}] Batch API - Incidents: ${incidents.length}, Policies: ${Object.keys(policies).length}`);
            console.log('üìã Available policies:', Object.keys(policies));
            console.log('üìã Policies object structure:', policies);  // Ï†ÑÏ≤¥ Íµ¨Ï°∞ ÌôïÏù∏
            console.log('üìã Fallback policy:', policy ? (policy.policy_id || 'no policy_id') : 'null');
            console.log('üìã Incidents with fall_type:', incidents.map(inc => ({id: inc.incident_id, fall_type: inc.fall_type})));
            
            if (incidents.length === 0) {
                showEmpty('No visits scheduled', 'No Fall incidents found for this date');
                return;
            }
            
            // Policies ÌôïÏù∏ Î∞è Í≤ΩÍ≥†
            if (Object.keys(policies).length === 0) {
                console.error('‚ùå No policies found in API response!');
                console.error('API response data:', data);
                
                if (!policy) {
                    showEmpty('Policy Setup Required', 
                        'No active Fall policy found. Please run <strong>Force Synchronization</strong> from Settings page to initialize the system.<br><br>' +
                        '<a href="/admin-settings" class="btn btn-primary btn-sm mt-2">Go to Settings</a>',
                        true);
                    return;
                } else {
                    console.warn('‚ö†Ô∏è Using fallback policy (legacy mode)');
                }
            } else {
                console.log('‚úÖ Policies loaded successfully:', Object.keys(policies));
            }
            
            // incidentTasksMap Íµ¨ÏÑ± (Batch APIÎäî Ïù¥ÎØ∏ tasks Ìè¨Ìï®)
            const incidentTasksMap = {};
            incidents.forEach(inc => {
                incidentTasksMap[inc.id] = inc.tasks || [];
                // ÎîîÎ≤ÑÍπÖ: task Ïàò Î°úÍ∑∏
                if (inc.tasks && inc.tasks.length > 0) {
                    console.log(`üìã Incident ${inc.incident_id}: ${inc.tasks.length} tasks loaded`);
                } else {
                    console.warn(`‚ö†Ô∏è Incident ${inc.incident_id}: NO TASKS in API response!`);
                }
            });
            
            // Generate all visits for all Fall incidents
            const allVisits = [];
            
            incidents.forEach(incident => {
                // Í∞Å incidentÏùò fall_typeÏóê Îî∞Îùº Ï†ÅÏ†àÌïú policy ÏÑ†ÌÉù
                let selectedPolicy = null;
                let selectedPolicyId = null;
                
                console.log(`üîç Processing incident ${incident.incident_id}: fall_type="${incident.fall_type}"`);
                
                if (incident.fall_type === 'witnessed') {
                    selectedPolicyId = 'FALL-002-WITNESSED';
                } else {
                    // unwitnessed, unknown, or null -> use unwitnessed policy (safer)
                    selectedPolicyId = 'FALL-001-UNWITNESSED';
                }
                
                console.log(`  ‚Üí Selected policy ID: ${selectedPolicyId}`);
                console.log(`  ‚Üí Available policies:`, Object.keys(policies));
                console.log(`  ‚Üí Policies object:`, policies);  // ÎîîÎ≤ÑÍπÖ: Ï†ÑÏ≤¥ Í∞ùÏ≤¥ ÌôïÏù∏
                
                selectedPolicy = policies[selectedPolicyId];
                
                // Fallback: Ï†ïÌôïÌïú policy_idÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏúºÎ©¥ prefixÎ°ú ÏãúÏûëÌïòÎäî policy Ï∞æÍ∏∞
                // Ïòà: FALL-001-UNWITNESSEDÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏúºÎ©¥ FALL-001Î°ú ÏãúÏûëÌïòÎäî policy ÏÇ¨Ïö©
                if (!selectedPolicy) {
                    const policyKeys = Object.keys(policies);
                    const prefixMatch = policyKeys.find(key => selectedPolicyId.startsWith(key) || key.startsWith(selectedPolicyId.split('-').slice(0, 2).join('-')));
                    
                    if (prefixMatch) {
                        console.log(`  ‚ÑπÔ∏è Policy ${selectedPolicyId} not found, using ${prefixMatch} (prefix match)`);
                        selectedPolicy = policies[prefixMatch];
                    } else {
                        console.warn(`  ‚ö†Ô∏è Policy ${selectedPolicyId} not found in policies object, using fallback policy`);
                        console.warn(`  ‚Üí Available keys:`, policyKeys);
                        console.warn(`  ‚Üí Looking for:`, selectedPolicyId);
                        selectedPolicy = policy;
                    }
                }
                
                if (!selectedPolicy) {
                    console.error(`  ‚ùå No policy found for incident ${incident.incident_id} (fall_type: ${incident.fall_type})`);
                    return;
                }
                
                const policyRules = selectedPolicy.rules;
                const visitSchedule = policyRules.nurse_visit_schedule || [];
                const commonTasks = policyRules.common_assessment_tasks || '';
                
                console.log(`  ‚úÖ Using policy ${selectedPolicyId} (${visitSchedule.length} phases, ${visitSchedule.map(p => `${p.interval}${p.interval_unit} for ${p.duration}${p.duration_unit}`).join(', ')})`);
                
                // üîß Í∞úÏÑ†: Ïã§Ï†ú taskÍ∞Ä ÏûàÏúºÎ©¥ taskÏùò due_dateÎ•º Í∏∞Ï§ÄÏúºÎ°ú visit ÏÉùÏÑ±
                // Policy scheduleÏùÄ Ï∞∏Í≥†Ïö©ÏúºÎ°úÎßå ÏÇ¨Ïö©
                const tasks = incidentTasksMap[incident.id] || [];
                
                if (tasks.length > 0) {
                    // Ïã§Ï†ú taskÍ∞Ä ÏûàÎäî Í≤ΩÏö∞: taskÏùò due_dateÎ•º Í∏∞Ï§ÄÏúºÎ°ú visit ÏÉùÏÑ±
                    console.log(`  üìã Using ${tasks.length} actual tasks for visit generation`);
                    
                    tasks.forEach((task, taskIndex) => {
                        if (!task.due_date) return;
                        
                        const taskDueDate = new Date(task.due_date);
                        const taskStatus = task.status || 'pending';
                        const completedAt = task.completed_at || null;
                        
                        // Phase Ï†ïÎ≥¥ Ï∂îÏ∂ú (task_idÏóêÏÑú: TASK-INC423-P3-V10 -> Phase 3)
                        const phaseMatch = task.task_id ? task.task_id.match(/P(\d+)/) : null;
                        const phaseIndex = phaseMatch ? parseInt(phaseMatch[1]) - 1 : 0;
                        
                        allVisits.push({
                            incidentId: incident.id,
                            residentName: incident.resident_name,
                            location: incident.location || '',
                            incidentType: incident.incident_type,
                            incidentDate: incident.incident_date,
                            description: incident.description || '',
                            fall_type: incident.fall_type || null,
                            visitTime: taskDueDate,  // Ïã§Ï†ú taskÏùò due_date ÏÇ¨Ïö©
                            phaseIndex: phaseIndex + 1,
                            tasks: commonTasks,
                            taskStatus: taskStatus,
                            completedAt: completedAt,
                            taskId: task.task_id,  // Ïã§Ï†ú task ID Ï†ÄÏû•
                            taskDueDate: task.due_date  // ÏõêÎ≥∏ due_date Ï†ÄÏû•
                        });
                    });
                } else {
                    // TaskÍ∞Ä ÏóÜÎäî Í≤ΩÏö∞: Policy schedule Í∏∞Î∞òÏúºÎ°ú visit ÏÉùÏÑ± (ÏòàÏÉÅ Ïä§ÏºÄÏ§Ñ)
                    console.log(`  ‚ö†Ô∏è No tasks found, using policy schedule for expected visits`);
                    
                    const incidentTime = new Date(incident.incident_date);
                    let phaseStartTime = new Date(incidentTime);
                    
                    // Process each phase sequentially
                    visitSchedule.forEach((phase, phaseIndex) => {
                        const interval = parseInt(phase.interval) || 30;
                        const intervalUnit = (phase.interval_unit || 'minutes').toLowerCase();
                        const duration = parseInt(phase.duration) || 2;
                        const durationUnit = (phase.duration_unit || 'minutes').toLowerCase();
                        
                        // Convert to minutes
                        const intervalMinutes = intervalUnit === 'hours' ? interval * 60 : 
                                              intervalUnit === 'days' ? interval * 24 * 60 : interval;
                        const durationMinutes = durationUnit === 'hours' ? duration * 60 : 
                                              durationUnit === 'days' ? duration * 24 * 60 : duration;
                        
                        // Number of visits in this phase
                        const numberOfVisits = Math.ceil(durationMinutes / intervalMinutes);
                        
                        // Generate visits for this phase
                        for (let visitNum = 0; visitNum < numberOfVisits; visitNum++) {
                            const visitTime = new Date(phaseStartTime.getTime() + (visitNum * intervalMinutes * 60000));
                            
                            allVisits.push({
                                incidentId: incident.id,
                                residentName: incident.resident_name,
                                location: incident.location || '',
                                incidentType: incident.incident_type,
                                incidentDate: incident.incident_date,
                                description: incident.description || '',
                                fall_type: incident.fall_type || null,
                                visitTime: visitTime,
                                phaseIndex: phaseIndex + 1,
                                tasks: commonTasks,
                                taskStatus: 'pending',
                                completedAt: null
                            });
                        }
                        
                        // Next phase starts after current phase duration
                        phaseStartTime = new Date(phaseStartTime.getTime() + (durationMinutes * 60000));
                    });
                }
            });
            
            // Sort by visit time
            allVisits.sort((a, b) => a.visitTime - b.visitTime);
            
            // üîç ÏÑ†ÌÉùÌïú ÎÇ†ÏßúÏùò Î∞©Î¨∏Îßå ÌïÑÌÑ∞ÎßÅ (Î°úÏª¨ ÎÇ†Ïßú Í∏∞Ï§Ä)
            console.log(`üìÖ ÏÑ†ÌÉùÌïú ÎÇ†Ïßú: ${selectedDate}`);
            
            const filteredVisits = allVisits.filter(visit => {
                // taskDueDateÍ∞Ä ÏûàÏúºÎ©¥ Ïö∞ÏÑ† ÏÇ¨Ïö© (Îçî Ï†ïÌôïÌï®)
                let dateToCheck = null;
                
                if (visit.taskDueDate) {
                    // taskDueDateÍ∞Ä Î¨∏ÏûêÏó¥Ïù¥Î©¥ ÎÇ†Ïßú Î∂ÄÎ∂ÑÎßå Ï∂îÏ∂ú (ÌÉÄÏûÑÏ°¥ Î¨∏Ï†ú Î∞©ÏßÄ)
                    if (typeof visit.taskDueDate === 'string') {
                        // ISO ÌòïÏãù: 2026-01-01T08:00:00 ÎòêÎäî 2026-01-01T08:00:00.000000
                        const dateMatch = visit.taskDueDate.match(/^(\d{4}-\d{2}-\d{2})/);
                        if (dateMatch) {
                            dateToCheck = dateMatch[1]; // YYYY-MM-DD ÌòïÏãùÏúºÎ°ú ÏßÅÏ†ë Ï∂îÏ∂ú
                        } else {
                            // ÌååÏã± Ïã§Ìå® Ïãú Date Í∞ùÏ≤¥Î°ú Î≥ÄÌôò
                            dateToCheck = new Date(visit.taskDueDate);
                        }
                    } else {
                        dateToCheck = new Date(visit.taskDueDate);
                    }
                } else if (visit.visitTime) {
                    dateToCheck = visit.visitTime;
                }
                
                if (!dateToCheck) return false;
                
                // ÎÇ†Ïßú Ï∂îÏ∂ú (YYYY-MM-DD) - ÌÉÄÏûÑÏ°¥ ÏïàÏ†ÑÌïòÍ≤å Ï≤òÎ¶¨
                let checkLocalDate;
                if (typeof dateToCheck === 'string') {
                    // Ïù¥ÎØ∏ YYYY-MM-DD ÌòïÏãùÏù∏ Í≤ΩÏö∞
                    checkLocalDate = dateToCheck;
                } else {
                    // Date Í∞ùÏ≤¥Ïù∏ Í≤ΩÏö∞ Î°úÏª¨ ÎÇ†ÏßúÎ°ú Î≥ÄÌôò
                    const checkDate = new Date(dateToCheck);
                    const checkYear = checkDate.getFullYear();
                    const checkMonth = String(checkDate.getMonth() + 1).padStart(2, '0');
                    const checkDay = String(checkDate.getDate()).padStart(2, '0');
                    checkLocalDate = `${checkYear}-${checkMonth}-${checkDay}`;
                }
                
                const match = checkLocalDate === selectedDate;
                
                if (!match && allVisits.indexOf(visit) < 3) {
                    console.log(`  üîç Visit ${allVisits.indexOf(visit)}: ${checkLocalDate} vs ${selectedDate} = ${match}`);
                    console.log(`     visitTime: ${visit.visitTime ? visit.visitTime.toISOString() : 'none'}, taskDueDate: ${visit.taskDueDate || 'none'}`);
                }
                
                return match;
            });
            
            console.log(`üîç [${selectedSite}] Total visits: ${allVisits.length}, Filtered (${selectedDate}): ${filteredVisits.length}`);
            
            // ÌïÑÌÑ∞ÎßÅÎêú Î∞©Î¨∏Ïù¥ ÏóÜÏúºÎ©¥ empty state
            if (filteredVisits.length === 0) {
                showEmpty('No visits scheduled', 'No visits scheduled for this date');
                return;
            }
            
            // Color mapping for incidents (ÌïÑÌÑ∞ÎßÅÎêú Î∞©Î¨∏ Í∏∞Ï§Ä)
            const incidentColorMap = {};
            const colors = ['incident-color-1', 'incident-color-2', 'incident-color-3', 
                          'incident-color-4', 'incident-color-5', 'incident-color-6'];
            let colorIndex = 0;
            
            filteredVisits.forEach(visit => {
                if (!incidentColorMap[visit.incidentId]) {
                    incidentColorMap[visit.incidentId] = colors[colorIndex % colors.length];
                    colorIndex++;
                }
            });
            
            // Render table rows
            tableBody.innerHTML = '';
            const now = new Date();
            const todayStr = now.toISOString().split('T')[0];
            
            filteredVisits.forEach(visit => {
                const row = document.createElement('tr');
                const isPast = visit.visitTime < now;
                const isCompleted = visit.taskStatus === 'completed';
                const isOverdue = isPast && !isCompleted;
                
                // Current task detection (due within next hour, not completed)
                const timeDiff = (visit.visitTime - now) / 1000 / 60;
                const isCurrent = !isPast && timeDiff >= 0 && timeDiff <= 60 && 
                                 selectedDate === todayStr && !isCompleted;
                
                // Apply color class
                row.className = incidentColorMap[visit.incidentId];
                
                if (isOverdue) {
                    row.classList.add('overdue');
                }
                
                if (isCurrent) {
                    row.classList.add('current-task');
                }
                
                // Time cell
                const timeCell = document.createElement('td');
                timeCell.className = 'time-cell';
                timeCell.textContent = visit.visitTime.toLocaleTimeString('en-AU', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });
                row.appendChild(timeCell);
                
                // Patient cell
                const patientCell = document.createElement('td');
                patientCell.className = 'patient-cell';
                patientCell.textContent = visit.residentName;
                row.appendChild(patientCell);
                
                // Room cell
                const roomCell = document.createElement('td');
                roomCell.className = 'location-cell';
                roomCell.textContent = visit.location;
                row.appendChild(roomCell);
                
                // Type cell with Fall type badge
                const typeCell = document.createElement('td');
                typeCell.className = 'type-cell';
                
                // Create type text
                const typeText = document.createTextNode(visit.incidentType);
                typeCell.appendChild(typeText);
                
                // Add Fall type badge if available
                if (visit.incidentType.toLowerCase().includes('fall') && visit.fall_type) {
                    const badgeDiv = document.createElement('div');
                    badgeDiv.style.marginTop = '0.3rem';
                    
                    const badge = document.createElement('span');
                    badge.style.fontSize = '0.75rem';
                    badge.style.padding = '0.2rem 0.5rem';
                    badge.style.borderRadius = '8px';
                    badge.style.fontWeight = '600';
                    badge.style.display = 'inline-block';
                    
                    if (visit.fall_type === 'witnessed') {
                        badge.style.background = '#d4edda';
                        badge.style.color = '#155724';
                        badge.innerHTML = '<i class="fas fa-eye"></i> Witnessed';
                    } else if (visit.fall_type === 'unwitnessed') {
                        badge.style.background = '#fff3cd';
                        badge.style.color = '#856404';
                        badge.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Unwitnessed';
                    } else if (visit.fall_type === 'unknown') {
                        badge.style.background = '#e2e3e5';
                        badge.style.color = '#383d41';
                        badge.innerHTML = '<i class="fas fa-question-circle"></i> Unknown';
                    }
                    
                    badgeDiv.appendChild(badge);
                    typeCell.appendChild(badgeDiv);
                }
                
                row.appendChild(typeCell);
                
                // Occurred cell
                const occurredCell = document.createElement('td');
                occurredCell.className = 'occurred-cell';
                const incidentDate = new Date(visit.incidentDate);
                occurredCell.textContent = incidentDate.toLocaleDateString('en-GB', {
                    day: '2-digit',
                    month: 'short'
                }) + ', ' + incidentDate.toLocaleTimeString('en-AU', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                });
                row.appendChild(occurredCell);
                
                // Incident Details cell (ID only, click to view details)
                const incidentCell = document.createElement('td');
                incidentCell.className = 'incident-cell';
                incidentCell.title = 'Click to view details';
                
                const incidentId = document.createElement('div');
                incidentId.className = 'incident-id';
                incidentId.textContent = `${visit.incidentId}`;
                
                incidentCell.appendChild(incidentId);
                
                // Click event to show modal
                incidentCell.onclick = function() {
                    const occurredDate = incidentDate.toLocaleDateString('en-GB', {
                        day: '2-digit',
                        month: 'short',
                        year: 'numeric'
                    }) + ', ' + incidentDate.toLocaleTimeString('en-AU', {
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: true
                    });
                    
                    showIncidentModal({
                        incidentId: visit.incidentId,
                        residentName: visit.residentName,
                        occurred: occurredDate,
                        location: visit.location,
                        incidentType: visit.incidentType,
                        fall_type: visit.fall_type,  // Fall type Ï∂îÍ∞Ä
                        description: visit.description,
                        tasks: visit.tasks
                    });
                };
                
                row.appendChild(incidentCell);
                
                // Tasks cell (show more content with smaller font)
                const tasksCell = document.createElement('td');
                tasksCell.className = 'tasks-cell';
                const shortTasks = visit.tasks.substring(0, 80);
                tasksCell.textContent = shortTasks + (visit.tasks.length > 80 ? '...' : '');
                row.appendChild(tasksCell);
                
                // Phase cell
                const phaseCell = document.createElement('td');
                phaseCell.className = 'text-center';
                const phaseBadge = document.createElement('span');
                phaseBadge.className = 'phase-badge';
                phaseBadge.textContent = `P${visit.phaseIndex}`;
                phaseCell.appendChild(phaseBadge);
                row.appendChild(phaseCell);
                
                // Status cell
                const statusCell = document.createElement('td');
                statusCell.className = 'text-center';
                const statusBadge = document.createElement('span');
                
                // üîç Status Î°úÏßÅ Í∞úÏÑ†
                let statusText = '';
                let statusClass = '';
                
                // ÎîîÎ≤ÑÍ∑∏ Î°úÍ∑∏ (Warren HENDERSONÎßå)
                if (visit.residentName.includes('HENDERSON')) {
                    console.log(`[Status Debug] ${visit.residentName} at ${visit.visitTime.toLocaleTimeString('en-AU')}:`);
                    console.log(`  - Current time (Local): ${now.toLocaleString('en-AU')}`);
                    console.log(`  - Current time (UTC): ${now.toISOString()}`);
                    console.log(`  - Visit time (Local): ${visit.visitTime.toLocaleString('en-AU')}`);
                    console.log(`  - Visit time (UTC): ${visit.visitTime.toISOString()}`);
                    console.log(`  - Time diff (minutes): ${Math.round((now - visit.visitTime) / 1000 / 60)}`);
                    console.log(`  - isPast: ${isPast} (visitTime < now: ${visit.visitTime < now})`);
                    console.log(`  - taskStatus: ${visit.taskStatus}`);
                }
                
                if (visit.taskStatus === 'completed') {
                    // ÏôÑÎ£åÎê®
                    statusText = 'OK';
                    statusClass = 'status-ok';
                } else if (isPast) {
                    // ÏãúÍ∞ÑÏù¥ ÏßÄÎÇ¨ÎäîÎç∞ ÏôÑÎ£å ÏïàÎê® ‚Üí Overdue
                    statusText = 'NOK';
                    statusClass = 'status-overdue';
                    } else {
                    // ÏïÑÏßÅ ÏãúÍ∞ÑÏù¥ ÏïàÎê® ‚Üí Waiting
                    statusText = 'Waiting';
                    statusClass = 'status-pending';
                }
                
                statusBadge.className = `status-badge ${statusClass}`;
                statusBadge.textContent = statusText;
                
                statusCell.appendChild(statusBadge);
                row.appendChild(statusCell);
                
                tableBody.appendChild(row);
            });
            
            // Update visit count (ÌïÑÌÑ∞ÎßÅÎêú Î∞©Î¨∏ Í∏∞Ï§Ä)
            visitCount.textContent = `${filteredVisits.length} visits`;
            
            // Hide loading
            hideLoading();
            
            // üéØ ÏûêÎèô Ïä§ÌÅ¨Î°§: ÌòÑÏû¨ ÏãúÍ∞Ñ Ïù¥ÌõÑ Ï≤´ Î≤àÏß∏ ÎØ∏ÏôÑÎ£å ÌÉúÏä§ÌÅ¨Î°ú Ïù¥Îèô
            scrollToNextTask();
        }

        // Generate visit schedule from incidents (table format)
        async function generateVisitSchedule(incidents) {
            const tableBody = document.getElementById('scheduleTableBody');
            const visitCount = document.getElementById('visitCount');

            console.log(`üîç [${selectedSite}] Total incidents:`, incidents.length);

            // Filter Fall incidents first (before fetching tasks)
            const fallIncidents = incidents.filter(inc => 
                (inc.incident_type || '').toLowerCase().includes('fall')
            );

            console.log(`üîç [${selectedSite}] Fall incidents:`, fallIncidents.length);

            if (fallIncidents.length === 0) {
                console.log(`‚ÑπÔ∏è [${selectedSite}] No Fall incidents found, showing empty state`);
                showEmpty('No visits scheduled', 'No visits scheduled for this date');
                return;
            }

            // Fetch task data for Fall incidents only
            const incidentTasksMap = {};
            for (const incident of fallIncidents) {
                try {
                    const response = await fetch(`/api/cims/incident/${incident.id}/tasks`);
                    if (response.ok) {
                        const data = await response.json();
                        incidentTasksMap[incident.id] = data.tasks || [];
                    }
                } catch (error) {
                    console.error(`Failed to load tasks for incident ${incident.id}:`, error);
                    incidentTasksMap[incident.id] = [];
                }
            }

            // Fetch Fall policy
            const policyResponse = await fetch('/api/cims/policies');
            const policies = await policyResponse.json();
            const fallPolicy = policies.find(p => {
                try {
                    const rules = JSON.parse(p.rules_json);
                    const association = rules.incident_association || {};
                    return association.incident_type === 'Fall';
                } catch {
                    return false;
                }
            });

            if (!fallPolicy) {
                showEmpty('No visits scheduled', 'No visits scheduled for this date');
                return;
            }

            const policyRules = JSON.parse(fallPolicy.rules_json);
            const visitSchedule = policyRules.nurse_visit_schedule || [];
            const commonTasks = policyRules.common_assessment_tasks || '';

            // Generate all visits for all Fall incidents
            const allVisits = [];

            fallIncidents.forEach(incident => {
                const incidentTime = new Date(incident.incident_date);
                let phaseStartTime = new Date(incidentTime);
                
                // Process each phase sequentially
                visitSchedule.forEach((schedule, idx) => {
                    const interval = schedule.interval;
                    const intervalUnit = schedule.interval_unit;
                    const duration = schedule.duration;
                    const durationUnit = schedule.duration_unit;

                    // Convert to minutes
                    const intervalMinutes = intervalUnit === 'hours' ? interval * 60 : interval;
                    const durationMinutes = durationUnit === 'hours' ? duration * 60 : 
                                          durationUnit === 'days' ? duration * 24 * 60 : duration;

                    // Calculate number of visits in this phase
                    const numberOfVisits = Math.floor(durationMinutes / intervalMinutes);
                    
                    // Generate visits for this phase
                    for (let i = 1; i <= numberOfVisits; i++) {
                        const visitTime = new Date(phaseStartTime.getTime() + (intervalMinutes * i * 60 * 1000));
                        
                        // Only include if on selected date
                        if (visitTime.toISOString().split('T')[0] === selectedDate) {
                            // Find matching task by due_date
                            const incidentTasks = incidentTasksMap[incident.id] || [];
                            const matchingTask = incidentTasks.find(task => {
                                if (!task.due_date) return false;
                                const taskDue = new Date(task.due_date);
                                // Match within 30 minute window (to match backend logic)
                                const timeDiff = Math.abs(taskDue - visitTime);
                                return timeDiff < 30 * 60 * 1000;
                            });
                            
                            allVisits.push({
                                time: visitTime,
                                incident: incident,
                                schedule: schedule,
                                phase: idx + 1,
                                visitNumber: i,
                                totalVisitsInPhase: numberOfVisits,
                                tasks: commonTasks,
                                interval: `Every ${interval} ${intervalUnit}`,
                                duration: `For ${duration} ${durationUnit}`,
                                taskStatus: matchingTask ? matchingTask.status : 'pending'
                            });
                        }
                    }
                    
                    // Next phase starts after current phase ends
                    phaseStartTime = new Date(phaseStartTime.getTime() + durationMinutes * 60 * 1000);
                });
            });

            // Sort by time
            allVisits.sort((a, b) => a.time - b.time);

            // Assign color index to each unique incident
            const incidentColorMap = {};
            let colorIndex = 1;
            allVisits.forEach(visit => {
                const incidentId = visit.incident.incident_id;
                if (!incidentColorMap[incidentId]) {
                    incidentColorMap[incidentId] = colorIndex;
                    colorIndex = (colorIndex % 6) + 1; // Cycle through 6 colors
                }
            });

            // Display as table
            let html = '';
            const now = new Date();

            allVisits.forEach(visit => {
                const timeStr = visit.time.toLocaleTimeString('en-AU', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });
                
                const isPast = visit.time < now;
                const isOverdue = isPast && selectedDate === new Date().toISOString().split('T')[0];
                
                // Check if this is a current task (ÌòÑÏû¨ ÏãúÍ∞ÑÎ∂ÄÌÑ∞ 1ÏãúÍ∞Ñ Ïù¥ÎÇ¥Ïóê Î∞©Î¨∏Ìï¥Ïïº ÌïòÎäî Í≤ΩÏö∞)
                const timeDiff = (visit.time - now) / (1000 * 60); // Î∂Ñ Îã®ÏúÑ Ï∞®Ïù¥
                const todayStr = new Date().toISOString().split('T')[0];
                const isCurrent = !isPast && timeDiff >= 0 && timeDiff <= 60 && selectedDate === todayStr;
                
                // Debug logging for Warren HENDERSON or current hour tasks
                if (visit.incident.resident_name.includes('HENDERSON') || (timeDiff >= 0 && timeDiff <= 60)) {
                    console.log(`[Blink Debug] ${visit.incident.resident_name} at ${timeStr}:`);
                    console.log(`  - Current time: ${now.toLocaleTimeString('en-AU')}`);
                    console.log(`  - Visit time: ${visit.time.toLocaleTimeString('en-AU')}`);
                    console.log(`  - Time diff: ${timeDiff.toFixed(1)} minutes`);
                    console.log(`  - isPast: ${isPast}`);
                    console.log(`  - selectedDate: ${selectedDate}, todayStr: ${todayStr}`);
                    console.log(`  - taskStatus: ${visit.taskStatus}`);
                    console.log(`  - isCurrent: ${isCurrent}`);
                    console.log(`  - Will blink: ${isCurrent && visit.taskStatus !== 'completed'}`);
                }
                
                // Get incident color
                const incidentColor = incidentColorMap[visit.incident.incident_id];
                let rowClass = `incident-color-${incidentColor}`;
                
                // Apply status classes
                if (isOverdue) {
                    rowClass += ' overdue';
                } else if (isCurrent && visit.taskStatus !== 'completed') {
                    rowClass += ' current-task';
                }
                
                // Extract room from location
                const location = visit.incident.location || '';
                const roomMatch = location.match(/(\d{3}:\s*\w+)|(\d{3})|Room\s+\d+/i);
                const room = roomMatch ? roomMatch[0] : location.split(',')[0].trim();
                
                // Format incident date/time
                const incidentDate = new Date(visit.incident.incident_date);
                const incidentDateStr = incidentDate.toLocaleDateString('en-AU', {
                    day: 'numeric',
                    month: 'short',
                    year: 'numeric'
                });
                const incidentTimeStr = incidentDate.toLocaleTimeString('en-AU', {
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: true 
                });
                
                // Get incident type
                const incidentType = visit.incident.incident_type || 'Unknown';
                
                // Simplified description (50 characters)
                const description = visit.incident.description || '';
                const descWords = description.split(' ');
                let descSummary = '';
                for (let i = 0; i < descWords.length && descSummary.length < 50; i++) {
                    descSummary += descWords[i] + ' ';
                }
                if (description.length > 50) descSummary += '...';
                
                // Shortened tasks (first line only, 30 chars)
                const taskLines = visit.tasks.split('\n').filter(t => t.trim());
                const firstTask = taskLines.length > 0 ? taskLines[0].replace(/^[‚Ä¢\-\s]+/, '').trim() : 'Assessment';
                const tasksSummary = firstTask.substring(0, 30) + (firstTask.length > 30 ? '...' : '');
                
                // Check Progress Note status via task completion
                // Tasks are expected to have a status field from the backend
                const progressNoteStatus = visit.taskStatus || 'pending';
                
                // Debug log for task status
                if (visit.incident.resident_name.includes('Maxwell')) {
                    console.log(`[Task Status] ${visit.incident.resident_name} at ${timeStr}: taskStatus=${visit.taskStatus}, progressNoteStatus=${progressNoteStatus}`);
                }
                
                // üîç Status Î°úÏßÅ Í∞úÏÑ†
                let statusBadge = '';
                if (visit.taskStatus === 'completed' || progressNoteStatus === 'completed') {
                    // ÏôÑÎ£åÎê®
                    statusBadge = '<span class="status-badge status-ok"><i class="fas fa-check-circle me-1"></i>OK</span>';
                } else if (isPast) {
                    // ÏãúÍ∞ÑÏù¥ ÏßÄÎÇ¨ÎäîÎç∞ ÏôÑÎ£å ÏïàÎê® ‚Üí Overdue
                    statusBadge = '<span class="status-badge status-overdue"><i class="fas fa-exclamation-circle me-1"></i>NOK</span>';
                } else {
                    // ÏïÑÏßÅ ÏãúÍ∞ÑÏù¥ ÏïàÎê® ‚Üí Waiting
                    statusBadge = '<span class="status-badge status-pending"><i class="fas fa-clock me-1"></i>Waiting</span>';
                }

                html += `
                    <tr class="${rowClass}" onclick="showVisitDetails('${visit.incident.incident_id}', '${timeStr}')">
                        <td class="time-cell">${timeStr}</td>
                        <td class="patient-cell">${visit.incident.resident_name}</td>
                        <td class="location-cell">${room}</td>
                        <td class="type-cell">${incidentType}</td>
                        <td class="occurred-cell">${incidentDateStr}<br>${incidentTimeStr}</td>
                        <td class="incident-cell">
                            <span class="incident-id">${visit.incident.incident_id}</span>
                            <div class="incident-description">${descSummary.trim()}</div>
                        </td>
                        <td class="tasks-cell">${tasksSummary}</td>
                        <td class="text-center">
                            <span class="phase-badge">P${visit.phase}</span>
                        </td>
                        <td class="status-cell">
                            ${statusBadge}
                        </td>
                    </tr>
                `;
            });

            tableBody.innerHTML = html;
            visitCount.textContent = `${allVisits.length} visits`;
            hideLoading();
        }

        // Show visit details
        // Legacy function - replaced by showIncidentModal
        function showVisitDetails(incidentId, time) {
            // No longer used - incident modal is used instead
        }

        // Show loading
        function showLoading() {
            document.getElementById('loadingSpinner').classList.add('active');
            document.querySelector('.schedule-table-wrapper').style.display = 'none';
        }

        // Hide loading
        function hideLoading() {
            document.getElementById('loadingSpinner').classList.remove('active');
            document.querySelector('.schedule-table-wrapper').style.display = 'block';
        }

        // Show empty state
        function showEmpty(message, subtitle, allowHtml = false) {
            hideLoading();
            const tableBody = document.getElementById('scheduleTableBody');
            
            const subtitleHtml = allowHtml ? subtitle : `<small style="color: #999; font-size: 1.1rem; font-weight: 600;">${subtitle}</small>`;
            
            tableBody.innerHTML = `
                <tr>
                    <td colspan="9" class="text-center" style="padding: 3rem;">
                        <i class="fas fa-calendar-alt" style="font-size: 4rem; color: #ccc; display: block; margin-bottom: 1.5rem;"></i>
                        <p style="color: #666; font-size: 1.4rem; font-weight: 700;">${message}</p>
                        <div style="color: #999; font-size: 1.1rem; font-weight: 600;">${subtitleHtml}</div>
                        </td>
                    </tr>
                `;
            document.getElementById('visitCount').textContent = '0 visits';
        }

        // Update last update time
        function updateLastUpdateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-AU', {
                hour: '2-digit',
                minute: '2-digit'
            });
            document.getElementById('lastUpdate').textContent = `Updated: ${timeStr}`;
        }
        
        // üïê ÌòÑÏû¨ ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏ (1Ï¥àÎßàÎã§)
        function updateCurrentTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-AU', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            document.getElementById('currentTimeDisplay').textContent = timeStr;
        }

        // Auto refresh
        function startAutoRefresh() {
            // Refresh every 5 minutes
            autoRefreshInterval = setInterval(() => {
                if (selectedSite && selectedDate) {
                    const indicator = document.getElementById('autoRefreshIndicator');
                    indicator.classList.add('active');
                    
                    loadSchedule().then(() => {
                        setTimeout(() => {
                            indicator.classList.remove('active');
                        }, 2000);
                    });
                }
            }, 5 * 60 * 1000); // 5 minutes
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initializeDateDropdown();
            
            // üïê ÌòÑÏû¨ ÏãúÍ∞Ñ ÌëúÏãú ÏãúÏûë (1Ï¥àÎßàÎã§ ÏóÖÎç∞Ïù¥Ìä∏)
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            // Load saved site from localStorage
            const savedSite = localStorage.getItem('selectedSite');
            if (savedSite) {
                document.getElementById('siteSelect').value = savedSite;
                selectedSite = savedSite;
                loadSchedule();
            }
            
            // Save site selection
            document.getElementById('siteSelect').addEventListener('change', (e) => {
                localStorage.setItem('selectedSite', e.target.value);
            });

            // Start auto refresh
            startAutoRefresh();
        });

        // üéØ ÏûêÎèô Ïä§ÌÅ¨Î°§: ÌòÑÏû¨ ÏãúÍ∞Ñ Í∏∞Ï§Ä Îã§Ïùå ÌÉúÏä§ÌÅ¨Î°ú Ïù¥Îèô
        function scrollToNextTask() {
            // ÏïΩÍ∞ÑÏùò ÏßÄÏó∞ ÌõÑ Ïä§ÌÅ¨Î°§ (Î†åÎçîÎßÅ ÏôÑÎ£å ÎåÄÍ∏∞)
            setTimeout(() => {
                const now = new Date();
                const todayStr = now.toISOString().split('T')[0];
                
                // Ïò§Îäò ÎÇ†ÏßúÍ∞Ä ÏïÑÎãàÎ©¥ Ïä§ÌÅ¨Î°§ÌïòÏßÄ ÏïäÏùå
                if (selectedDate !== todayStr) {
                    console.log(`üìÖ Ïò§ÎäòÏù¥ ÏïÑÎãò (${selectedDate}), ÏûêÎèô Ïä§ÌÅ¨Î°§ ÏÉùÎûµ`);
                    return;
                }
                
                // Î™®Îì† ÌñâÏùÑ Í≤ÄÏÇ¨ÌïòÏó¨ Îã§Ïùå ÌÉúÏä§ÌÅ¨ Ï∞æÍ∏∞
                const rows = document.querySelectorAll('#scheduleTableBody tr');
                let nextTaskRow = null;
                let nextTaskIndex = -1;
                
                rows.forEach((row, index) => {
                    // Ïù¥ÎØ∏ Îã§Ïùå ÌÉúÏä§ÌÅ¨Î•º Ï∞æÏïòÏúºÎ©¥ Í±¥ÎÑàÎõ∞Í∏∞
                    if (nextTaskRow) return;
                    
                    // Time ÏÖÄÏóêÏÑú ÏãúÍ∞Ñ Ï∂îÏ∂ú (Ï≤´ Î≤àÏß∏ td)
                    const timeCell = row.querySelector('.time-cell');
                    if (!timeCell) return;
                    
                    const timeStr = timeCell.textContent.trim();
                    
                    // ÏãúÍ∞Ñ ÌååÏã± (HH:MM ÌòïÏãù)
                    const [hours, minutes] = timeStr.split(':').map(Number);
                    const taskTime = new Date();
                    taskTime.setHours(hours, minutes, 0, 0);
                    
                    // Status ÏÖÄÏóêÏÑú ÏôÑÎ£å Ïó¨Î∂Ä ÌôïÏù∏
                    const statusBadge = row.querySelector('.status-badge');
                    const isCompleted = statusBadge && statusBadge.classList.contains('status-ok');
                    
                    // ÌòÑÏû¨ ÏãúÍ∞Ñ Ïù¥ÌõÑÏù¥Í≥† ÎØ∏ÏôÑÎ£åÏù∏ Ï≤´ Î≤àÏß∏ ÌÉúÏä§ÌÅ¨
                    if (taskTime >= now && !isCompleted) {
                        nextTaskRow = row;
                        nextTaskIndex = index;
                    }
                });
                
                // Îã§Ïùå ÌÉúÏä§ÌÅ¨Í∞Ä ÏûàÏúºÎ©¥ Ïä§ÌÅ¨Î°§
                if (nextTaskRow) {
                    console.log(`üéØ Îã§Ïùå ÌÉúÏä§ÌÅ¨Î°ú ÏûêÎèô Ïä§ÌÅ¨Î°§ (index: ${nextTaskIndex})`);
                    
                    // ÌéòÏù¥ÏßÄ Ï§ëÏïôÏóê ÏúÑÏπòÌïòÎèÑÎ°ù Ïä§ÌÅ¨Î°§
                    nextTaskRow.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center',  // Ï§ëÏïôÏóê ÏúÑÏπò!
                        inline: 'nearest'
                    });
                    
                    // ÏãúÍ∞ÅÏ†Å ÌîºÎìúÎ∞±: Ïû†Íπê Í∞ïÏ°∞ ÌëúÏãú
                    nextTaskRow.style.transition = 'all 0.5s ease';
                    nextTaskRow.style.transform = 'scale(1.02)';
                    
                    setTimeout(() => {
                        nextTaskRow.style.transform = 'scale(1)';
                    }, 1000);
                } else {
                    console.log(`‚ÑπÔ∏è  Îã§Ïùå ÌÉúÏä§ÌÅ¨ ÏóÜÏùå (Î™®Îëê ÏôÑÎ£å ÎòêÎäî Í≥ºÍ±∞)`);
                }
            }, 300);  // 300ms ÏßÄÏó∞ (Î†åÎçîÎßÅ ÏôÑÎ£å ÎåÄÍ∏∞)
        }
        
        // Incident Modal functions
        let modalAutoCloseTimer = null;

        function showIncidentModal(incidentData) {
            const modal = document.getElementById('incidentModal');
            
            // Populate modal content
            document.getElementById('modalIncidentId').textContent = `INC-${incidentData.incidentId}`;
            document.getElementById('modalPatientName').textContent = incidentData.residentName;
            document.getElementById('modalOccurred').textContent = incidentData.occurred;
            document.getElementById('modalLocation').textContent = incidentData.location;
            
            // Incident Type with Fall type badge
            let typeHtml = incidentData.incidentType;
            if (incidentData.incidentType.toLowerCase().includes('fall') && incidentData.fall_type) {
                let badgeStyle = '';
                let badgeText = '';
                
                if (incidentData.fall_type === 'witnessed') {
                    badgeStyle = 'background: #d4edda; color: #155724; padding: 0.3rem 0.6rem; border-radius: 8px; font-size: 0.85rem; margin-left: 0.5rem; font-weight: 600;';
                    badgeText = '<i class="fas fa-eye"></i> Witnessed';
                } else if (incidentData.fall_type === 'unwitnessed') {
                    badgeStyle = 'background: #fff3cd; color: #856404; padding: 0.3rem 0.6rem; border-radius: 8px; font-size: 0.85rem; margin-left: 0.5rem; font-weight: 600;';
                    badgeText = '<i class="fas fa-exclamation-triangle"></i> Unwitnessed';
                } else if (incidentData.fall_type === 'unknown') {
                    badgeStyle = 'background: #e2e3e5; color: #383d41; padding: 0.3rem 0.6rem; border-radius: 8px; font-size: 0.85rem; margin-left: 0.5rem; font-weight: 600;';
                    badgeText = '<i class="fas fa-question-circle"></i> Unknown';
                }
                
                typeHtml += `<span style="${badgeStyle}">${badgeText}</span>`;
            }
            
            document.getElementById('modalType').innerHTML = typeHtml;
            document.getElementById('modalDescription').textContent = incidentData.description;
            document.getElementById('modalTasks').innerHTML = incidentData.tasks.replace(/\n/g, '<br>');
            
            // Show modal
            modal.style.display = 'block';
            
            // Start auto-close timer (5 seconds)
            let secondsLeft = 5;
            document.getElementById('timerSeconds').textContent = secondsLeft;
            
            modalAutoCloseTimer = setInterval(() => {
                secondsLeft--;
                document.getElementById('timerSeconds').textContent = secondsLeft;
                
                if (secondsLeft <= 0) {
                    closeIncidentModal();
                }
            }, 1000);
            
            // Click outside to close
            modal.onclick = function(event) {
                if (event.target === modal) {
                    closeIncidentModal();
                }
            };
        }

        function closeIncidentModal() {
            const modal = document.getElementById('incidentModal');
            modal.style.display = 'none';
            
            // Clear timer
            if (modalAutoCloseTimer) {
                clearInterval(modalAutoCloseTimer);
                modalAutoCloseTimer = null;
            }
        }
    </script>

    <!-- Incident Details Modal -->
    <div id="incidentModal" class="incident-modal">
        <div class="incident-modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalIncidentId">INC-123</div>
                <button class="modal-close" onclick="closeIncidentModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-section">
                    <div class="modal-section-title">üë§ Patient</div>
                    <div class="modal-section-content" id="modalPatientName">-</div>
                </div>
                <div class="modal-section">
                    <div class="modal-section-title">üìÖ Occurred</div>
                    <div class="modal-section-content" id="modalOccurred">-</div>
                </div>
                <div class="modal-section">
                    <div class="modal-section-title">üìç Location</div>
                    <div class="modal-section-content" id="modalLocation">-</div>
                </div>
                <div class="modal-section">
                    <div class="modal-section-title">üìã Incident Type</div>
                    <div class="modal-section-content" id="modalType">-</div>
                </div>
                <div class="modal-section">
                    <div class="modal-section-title">üìù Description</div>
                    <div class="modal-section-content" id="modalDescription">-</div>
                </div>
                <div class="modal-section">
                    <div class="modal-section-title">‚úÖ Assessment Tasks</div>
                    <div class="modal-section-content" id="modalTasks">-</div>
                </div>
            </div>
            <div class="auto-close-timer" id="autoCloseTimer">Auto-closing in <span id="timerSeconds">5</span>s...</div>
        </div>
    </div>

</body>
</html>
