# Policy & Device Token DB 마이그레이션 분석

## 🔍 현재 상황 분석

### 📊 **Policy 관련 데이터**
- **현재 저장 방식**: 코드 내 하드코딩 또는 임시 더미 데이터
- **Policy & Alarm Management 페이지**: 이미 구현됨
- **API 엔드포인트**: 임시 더미 데이터로 구현됨
- **필요한 데이터**:
  - 알람 템플릿 (제목, 내용, 우선순위, 카테고리)
  - 수신자 정보 (이름, 이메일, 전화번호, 역할, 팀)
  - 에스컬레이션 정책 (단계별 알림 규칙)

### 📱 **Device Token (FCM) 관련 데이터**
- **현재 저장 방식**: `credential/fcm_tokens.json` 파일
- **관리 클래스**: `FCMTokenManager` (이미 구현됨)
- **데이터 구조**: 사용자별 토큰 배열
- **필요한 기능**:
  - 토큰 등록/해제
  - 토큰 유효성 검증
  - 디바이스 정보 관리
  - 자동 정리 (비활성 토큰)

---

## 💡 **추천 접근 방식**

### 🎯 **지금 함께 처리하는 것이 좋은 이유:**

1. **✅ Momentum 활용**: 현재 SQLite 마이그레이션 작업이 진행 중
2. **✅ 일관성**: 전체 시스템을 통일된 DB 기반으로 구축
3. **✅ 효율성**: 스키마가 이미 설계되어 있음 (database_schema.sql)
4. **✅ 테스트**: 기존 테스트 프레임워크 활용 가능

### 🚀 **즉시 구현 가능한 이유:**

1. **FCM Token**: 이미 SQLite 스키마에 `fcm_tokens` 테이블 존재
2. **Policy**: 이미 `alarm_templates`, `alarm_recipients` 테이블 존재
3. **기존 코드**: FCMTokenManager 클래스 이미 구현됨
4. **UI**: Policy & Alarm Management 페이지 이미 존재

---

## 📋 **구현 계획 (30분 내 완료 가능)**

### **Phase A: FCM Token 마이그레이션 (10분)**
```python
# 기존 credential/fcm_tokens.json → SQLite
# 이미 Phase 1에서 부분적으로 완료됨
# FCMTokenManager를 SQLite 기반으로 전환
```

### **Phase B: Policy 데이터 구조화 (15분)**
```python
# 현재 더미 데이터를 실제 DB 스키마로 이전
# 알람 템플릿, 수신자, 에스컬레이션 정책 DB화
```

### **Phase C: 통합 테스트 (5분)**
```python
# 새로운 기능들이 기존 시스템과 잘 연동되는지 확인
```

---

## 🎯 **즉시 처리 vs 나중 처리 비교**

| 항목 | 지금 처리 | 나중 처리 |
|------|-----------|-----------|
| **작업 시간** | +30분 | +2-3시간 |
| **일관성** | 전체 통합 | 부분적 |
| **테스트** | 기존 프레임워크 활용 | 별도 테스트 필요 |
| **리스크** | 낮음 (기존 작업 연장) | 높음 (새로운 작업) |
| **사용자 경험** | 통일된 관리 | 혼재된 시스템 |

---

## 💪 **권장사항: 지금 함께 처리!**

### **이유:**
1. **🔥 현재 momentum 활용** - 이미 마이그레이션 모드
2. **⚡ 빠른 완료** - 30분 내 완료 가능
3. **🎯 완전한 통합** - 전체 시스템이 SQLite 기반으로 통일
4. **🛡️ 낮은 리스크** - 기존 작업의 연장선

### **예상 효과:**
- ✅ **Policy 관리**: 웹 UI에서 실시간 편집 가능
- ✅ **FCM Token**: 자동 정리, 통계, 모니터링
- ✅ **통합 대시보드**: 모든 데이터를 한 곳에서 관리
- ✅ **성능**: Policy/Token 조회도 초고속화

### **작업 순서:**
1. **FCM Token 마이그레이션** (기존 JSON → SQLite)
2. **Policy 데이터 구조화** (더미 데이터 → 실제 DB)
3. **FCMTokenManager SQLite 전환**
4. **Policy Management 실제 기능 구현**
5. **통합 테스트**

이렇게 하면 **완전한 SQLite 기반 시스템**이 완성되고, 새로운 거주자뿐만 아니라 **새로운 정책이나 디바이스 추가**도 즉시 반영됩니다!
